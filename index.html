<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Kinship ‚Äî Family Social Network</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=Fraunces:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f0ede8;--surface:#ffffff;--surface2:#f7f5f2;
  --border:#e4dfd8;--border2:#d0c9c0;
  --text:#1c1a17;--text2:#6b6560;--text3:#a09a93;
  --primary:#2a6049;--primary-light:#e8f2ee;--primary-dark:#1d4434;
  --secondary:#c17f3a;--secondary-light:#fdf3e7;
  --danger:#c0392b;--danger-light:#fdf0ee;
  --male:#ddeaf8;--male-s:#4a88c4;
  --female:#fce8f0;--female-s:#c4608a;
  --radius:12px;--radius-sm:8px;--radius-lg:20px;
  --shadow:0 2px 12px rgba(0,0,0,.08);--shadow-lg:0 8px 40px rgba(0,0,0,.14);
  --nav-h:60px;--sidebar-w:260px;
}
html,body{height:100%;overflow:hidden;background:var(--bg);}
body{font-family:'Sora',sans-serif;color:var(--text);font-size:14px;}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px}

/* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
#auth-screen{
  position:fixed;inset:0;z-index:1000;
  background:linear-gradient(135deg,#1d4434 0%,#2a6049 40%,#3d8a68 80%,#c17f3a 100%);
  display:flex;align-items:center;justify-content:center;padding:20px;
}
.auth-card{
  background:#fff;border-radius:24px;width:100%;max-width:420px;
  box-shadow:0 30px 80px rgba(0,0,0,.3);overflow:hidden;
}
.auth-hero{
  background:linear-gradient(135deg,var(--primary-dark),var(--primary));
  padding:32px 32px 24px;text-align:center;
}
.auth-logo{font-family:'Fraunces',serif;font-size:2rem;color:#fff;letter-spacing:-.02em;}
.auth-logo span{color:#f0c98a;}
.auth-tagline{color:rgba(255,255,255,.7);font-size:.78rem;margin-top:4px;letter-spacing:.05em;}
.auth-body{padding:28px 32px 32px;}
.auth-tabs{display:flex;background:var(--surface2);border-radius:var(--radius-sm);padding:3px;margin-bottom:22px;}
.auth-tab{flex:1;padding:8px;text-align:center;border-radius:6px;cursor:pointer;font-size:.78rem;font-weight:500;color:var(--text2);transition:all .2s;}
.auth-tab.active{background:#fff;color:var(--primary);box-shadow:var(--shadow);}
.inp-group{margin-bottom:14px;}
.inp-group label{display:block;font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.07em;color:var(--text2);margin-bottom:5px;}
.inp-group input{
  width:100%;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  padding:10px 13px;font-family:'Sora',sans-serif;font-size:.83rem;
  color:var(--text);background:var(--surface2);outline:none;transition:border-color .15s;
}
.inp-group input:focus{border-color:var(--primary);}
.btn-auth{
  width:100%;background:var(--primary);color:#fff;border:none;
  border-radius:var(--radius-sm);padding:12px;
  font-family:'Sora',sans-serif;font-size:.88rem;font-weight:600;
  cursor:pointer;transition:background .15s;margin-top:4px;
}
.btn-auth:hover{background:var(--primary-dark);}
.demo-hint{margin-top:14px;text-align:center;font-size:.72rem;color:var(--text3);}
.demo-hint button{background:none;border:none;color:var(--primary);cursor:pointer;font-family:'Sora',sans-serif;font-size:.72rem;font-weight:600;text-decoration:underline;}

/* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
#app{display:none;height:100vh;flex-direction:column;}
#app.visible{display:flex;}

/* ‚îÄ‚îÄ TOP NAV ‚îÄ‚îÄ */
.topnav{
  height:var(--nav-h);background:var(--surface);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 16px;gap:12px;
  position:relative;z-index:100;flex-shrink:0;
}
.topnav-logo{font-family:'Fraunces',serif;font-size:1.3rem;color:var(--primary);letter-spacing:-.02em;flex-shrink:0;}
.topnav-logo span{color:var(--secondary);}
.topnav-search{
  flex:1;max-width:320px;position:relative;margin:0 12px;
}
.topnav-search input{
  width:100%;background:var(--surface2);border:1.5px solid var(--border);
  border-radius:99px;padding:7px 14px 7px 36px;
  font-family:'Sora',sans-serif;font-size:.78rem;color:var(--text);outline:none;
  transition:border-color .15s;
}
.topnav-search input:focus{border-color:var(--primary);}
.topnav-search .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:.85rem;}
.topnav-tabs{display:flex;gap:2px;flex:1;justify-content:center;}
.tnav-tab{
  padding:8px 16px;border-radius:var(--radius-sm);cursor:pointer;
  font-size:.75rem;font-weight:500;color:var(--text2);
  transition:all .15s;display:flex;align-items:center;gap:6px;
  border:none;background:none;font-family:'Sora',sans-serif;
}
.tnav-tab:hover{background:var(--surface2);color:var(--text);}
.tnav-tab.active{background:var(--primary-light);color:var(--primary);}
.tnav-tab .tnt-icon{font-size:1rem;}
.topnav-right{display:flex;align-items:center;gap:8px;margin-left:auto;}
.icon-btn{
  width:36px;height:36px;border-radius:50%;background:var(--surface2);
  border:1px solid var(--border);display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:.9rem;transition:all .15s;position:relative;
}
.icon-btn:hover{background:var(--primary-light);border-color:var(--primary);}
.notif-badge{
  position:absolute;top:2px;right:2px;width:8px;height:8px;
  background:var(--secondary);border-radius:50%;border:2px solid var(--surface);
}
.avatar-btn{
  width:36px;height:36px;border-radius:50%;overflow:hidden;cursor:pointer;
  border:2px solid var(--primary);flex-shrink:0;
}
.avatar-btn img{width:100%;height:100%;object-fit:cover;}

/* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
.main-layout{display:flex;flex:1;overflow:hidden;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{
  width:var(--sidebar-w);background:var(--surface);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;flex-shrink:0;
  overflow-y:auto;
}
.sidebar-section{padding:16px;}
.sidebar-section+.sidebar-section{border-top:1px solid var(--border);}
.sidebar-label{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);margin-bottom:10px;}
.sidebar-user{display:flex;align-items:center;gap:10px;padding:12px;border-radius:var(--radius);cursor:pointer;transition:background .15s;}
.sidebar-user:hover{background:var(--surface2);}
.su-av{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--primary);}
.su-name{font-size:.82rem;font-weight:600;color:var(--text);}
.su-handle{font-size:.7rem;color:var(--text3);}
.sidebar-nav-item{
  display:flex;align-items:center;gap:10px;padding:9px 12px;
  border-radius:var(--radius-sm);cursor:pointer;font-size:.8rem;font-weight:500;
  color:var(--text2);transition:all .15s;margin-bottom:2px;
}
.sidebar-nav-item:hover{background:var(--surface2);color:var(--text);}
.sidebar-nav-item.active{background:var(--primary-light);color:var(--primary);}
.sni-icon{width:20px;text-align:center;font-size:.9rem;}
.family-quick{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:var(--radius-sm);cursor:pointer;transition:background .15s;margin-bottom:3px;}
.family-quick:hover{background:var(--surface2);}
.fq-av{width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0;}
.fq-info{min-width:0;}
.fq-name{font-size:.75rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fq-rel{font-size:.65rem;color:var(--text3);}

/* ‚îÄ‚îÄ CONTENT AREA ‚îÄ‚îÄ */
.content-area{flex:1;overflow:hidden;display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page{display:none;flex:1;overflow:hidden;}
.page.active{display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ FEED PAGE ‚îÄ‚îÄ */
.feed-layout{display:flex;flex:1;overflow:hidden;}
.feed-main{flex:1;overflow-y:auto;padding:20px 16px;}
.feed-right{width:280px;background:var(--surface);border-left:1px solid var(--border);overflow-y:auto;padding:16px;flex-shrink:0;}

/* Stories */
.stories-row{display:flex;gap:10px;padding:4px 2px 16px;overflow-x:auto;}
.stories-row::-webkit-scrollbar{height:0}
.story-card{
  flex-shrink:0;width:90px;height:130px;border-radius:var(--radius);
  overflow:hidden;cursor:pointer;position:relative;
  background:linear-gradient(135deg,var(--primary),var(--secondary));
}
.story-card img{width:100%;height:100%;object-fit:cover;}
.story-av{
  position:absolute;top:8px;left:8px;width:30px;height:30px;
  border-radius:50%;border:2.5px solid var(--primary);overflow:hidden;
}
.story-av img{width:100%;height:100%;object-fit:cover;}
.story-name{
  position:absolute;bottom:0;left:0;right:0;
  background:linear-gradient(transparent,rgba(0,0,0,.6));
  padding:18px 6px 6px;font-size:.6rem;font-weight:500;color:#fff;
}
.add-story{background:var(--surface2);border:2px dashed var(--border2);}
.add-story-icon{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-60%);
  width:36px;height:36px;border-radius:50%;background:var(--primary);
  display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.2rem;
}

/* Post Card */
.post-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius-lg);margin-bottom:14px;overflow:hidden;
}
.post-header{display:flex;align-items:center;gap:10px;padding:14px 16px 10px;}
.ph-av{width:40px;height:40px;border-radius:50%;object-fit:cover;flex-shrink:0;}
.ph-info{flex:1;}
.ph-name{font-size:.82rem;font-weight:600;}
.ph-meta{font-size:.68rem;color:var(--text3);}
.ph-more{color:var(--text3);cursor:pointer;font-size:1rem;padding:4px;}
.post-text{padding:0 16px 12px;font-size:.83rem;line-height:1.55;color:var(--text);}
.post-img{width:100%;aspect-ratio:4/3;object-fit:cover;background:var(--surface2);}
.post-img-placeholder{
  width:100%;height:180px;background:linear-gradient(135deg,var(--primary-light),var(--secondary-light));
  display:flex;align-items:center;justify-content:center;font-size:2rem;
}
.post-actions{
  display:flex;padding:10px 12px;border-top:1px solid var(--border);gap:4px;
}
.post-action-btn{
  flex:1;display:flex;align-items:center;justify-content:center;gap:5px;
  padding:7px;border-radius:var(--radius-sm);cursor:pointer;
  font-size:.72rem;font-weight:500;color:var(--text2);
  transition:all .15s;border:none;background:none;font-family:'Sora',sans-serif;
}
.post-action-btn:hover{background:var(--surface2);color:var(--text);}
.post-action-btn.liked{color:#e74c3c;}
.post-action-btn .pab-icon{font-size:.9rem;}

/* Create Post */
.create-post{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius-lg);padding:14px 16px;margin-bottom:14px;
}
.cp-row{display:flex;align-items:center;gap:10px;}
.cp-input{
  flex:1;background:var(--surface2);border:1.5px solid var(--border);
  border-radius:99px;padding:9px 16px;
  font-family:'Sora',sans-serif;font-size:.82rem;cursor:pointer;
  color:var(--text3);outline:none;transition:border-color .15s;
}
.cp-input:focus{border-color:var(--primary);color:var(--text);}
.cp-actions{display:flex;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);}
.cp-action{
  display:flex;align-items:center;gap:5px;padding:6px 10px;border-radius:var(--radius-sm);
  cursor:pointer;font-size:.73rem;font-weight:500;color:var(--text2);
  transition:background .15s;border:none;background:none;font-family:'Sora',sans-serif;
}
.cp-action:hover{background:var(--surface2);}

/* Right sidebar widgets */
.widget{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:12px;}
.widget-title{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);margin-bottom:12px;}
.bday-item{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.bday-av{width:36px;height:36px;border-radius:50%;object-fit:cover;}
.bday-info{flex:1;font-size:.75rem;}
.bday-name{font-weight:500;}
.bday-note{color:var(--text3);font-size:.68rem;}
.suggestion{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.sug-av{width:36px;height:36px;border-radius:50%;object-fit:cover;}
.sug-info{flex:1;}
.sug-name{font-size:.75rem;font-weight:500;}
.sug-rel{font-size:.65rem;color:var(--text3);}
.btn-invite{
  background:var(--primary-light);color:var(--primary);border:1px solid rgba(42,96,73,.2);
  border-radius:var(--radius-sm);padding:4px 10px;font-family:'Sora',sans-serif;
  font-size:.7rem;font-weight:600;cursor:pointer;transition:background .15s;
}
.btn-invite:hover{background:#d4e8de;}

/* ‚îÄ‚îÄ FAMILY TREE PAGE ‚îÄ‚îÄ */
#tree-page{background:var(--bg);}
.tree-toolbar{
  height:52px;background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 16px;gap:10px;flex-shrink:0;
}
.tree-toolbar-title{font-family:'Fraunces',serif;font-size:1rem;color:var(--text);flex:1;}
.tb-btn{
  display:flex;align-items:center;gap:5px;padding:6px 12px;
  border-radius:var(--radius-sm);font-family:'Sora',sans-serif;
  font-size:.73rem;font-weight:500;cursor:pointer;transition:all .15s;border:none;
}
.tb-btn-outline{background:none;border:1.5px solid var(--border);color:var(--text2);}
.tb-btn-outline:hover{border-color:var(--primary);color:var(--primary);}
.tb-btn-primary{background:var(--primary);color:#fff;}
.tb-btn-primary:hover{background:var(--primary-dark);}

#tree-canvas-wrap{
  flex:1;overflow:auto;position:relative;cursor:grab;
  background-image:radial-gradient(circle,var(--border) 1px,transparent 1px);
  background-size:28px 28px;
}
#tree-canvas-wrap.panning{cursor:grabbing;}
#tree-canvas{position:relative;min-width:3000px;min-height:2000px;}
#tree-svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:visible;}

/* Tree Node */
.tnode{
  position:absolute;width:120px;
  background:var(--surface);border:2px solid var(--border);
  border-radius:var(--radius);padding:10px 8px 8px;
  cursor:pointer;transition:all .2s;text-align:center;
  box-shadow:0 2px 8px rgba(0,0,0,.06);
}
.tnode:hover,.tnode.hovered{
  border-color:var(--primary);box-shadow:0 4px 20px rgba(42,96,73,.15);
  transform:translateY(-2px);z-index:5;
}
.tnode.self-node{border-color:var(--primary);border-width:2.5px;background:var(--primary-light);}
.tnode.paternal{border-top:3px solid var(--secondary);}
.tnode.maternal{border-top:3px solid var(--male-s);}
.tnode-photo{
  width:52px;height:52px;border-radius:50%;margin:0 auto 6px;
  overflow:hidden;border:2px solid var(--border);background:var(--surface2);
  display:flex;align-items:center;justify-content:center;font-size:1.4rem;
}
.tnode-photo img{width:100%;height:100%;object-fit:cover;}
.tnode-name{font-size:.68rem;font-weight:600;line-height:1.3;color:var(--text);}
.tnode-rel{
  font-size:.58rem;font-weight:500;margin-top:3px;
  background:var(--primary-light);color:var(--primary);
  padding:1px 6px;border-radius:99px;display:inline-block;
}
.tnode-side-tag{
  position:absolute;top:-8px;left:50%;transform:translateX(-50%);
  font-size:.52rem;padding:1px 6px;border-radius:99px;color:#fff;white-space:nowrap;font-weight:600;
}
.tnode-side-tag.paternal{background:var(--secondary);}
.tnode-side-tag.maternal{background:var(--male-s);}

/* Node action buttons */
.tnode-actions{
  display:flex;justify-content:center;gap:3px;margin-top:6px;
  opacity:0;pointer-events:none;transition:opacity .15s;
}
.tnode:hover .tnode-actions{opacity:1;pointer-events:all;}
.tna-btn{
  width:20px;height:20px;border-radius:50%;border:1.5px solid var(--primary);
  background:var(--surface);color:var(--primary);font-size:.65rem;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .12s;
}
.tna-btn:hover{background:var(--primary);color:#fff;}

/* ‚îÄ‚îÄ PROFILE PAGE ‚îÄ‚îÄ */
.profile-cover{
  height:200px;background:linear-gradient(135deg,var(--primary-dark),var(--primary),var(--secondary));
  position:relative;flex-shrink:0;
}
.profile-cover-edit{
  position:absolute;bottom:12px;right:12px;
  background:rgba(255,255,255,.9);border-radius:var(--radius-sm);
  padding:5px 10px;font-size:.72rem;font-weight:500;cursor:pointer;
  display:flex;align-items:center;gap:5px;
}
.profile-info-row{
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:0 24px 14px;display:flex;align-items:flex-end;gap:16px;
  flex-shrink:0;
}
.profile-avatar-wrap{
  margin-top:-40px;position:relative;
}
.profile-avatar{
  width:90px;height:90px;border-radius:50%;border:4px solid var(--surface);
  object-fit:cover;background:var(--surface2);
  display:flex;align-items:center;justify-content:center;font-size:2rem;overflow:hidden;
}
.profile-avatar img{width:100%;height:100%;object-fit:cover;}
.profile-details{flex:1;padding-bottom:4px;}
.profile-name{font-family:'Fraunces',serif;font-size:1.4rem;color:var(--text);}
.profile-handle{font-size:.75rem;color:var(--text3);margin-top:2px;}
.profile-stats{display:flex;gap:18px;margin-top:8px;}
.pstat{text-align:center;}
.pstat-n{font-size:.95rem;font-weight:700;color:var(--text);}
.pstat-l{font-size:.65rem;color:var(--text3);}
.profile-actions{display:flex;gap:8px;padding-bottom:4px;}
.btn-profile-action{
  padding:8px 16px;border-radius:var(--radius-sm);font-family:'Sora',sans-serif;
  font-size:.75rem;font-weight:600;cursor:pointer;transition:all .15s;
}
.btn-pa-primary{background:var(--primary);color:#fff;border:none;}
.btn-pa-primary:hover{background:var(--primary-dark);}
.btn-pa-outline{background:none;border:1.5px solid var(--border);color:var(--text2);}
.btn-pa-outline:hover{border-color:var(--primary);color:var(--primary);}
.profile-body{flex:1;overflow-y:auto;padding:16px 24px;}
.profile-grid{display:grid;grid-template-columns:280px 1fr;gap:16px;}
.profile-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:16px;margin-bottom:12px;
}
.profile-card-title{font-size:.75rem;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;}
.profile-info-item{display:flex;align-items:center;gap:8px;margin-bottom:10px;font-size:.78rem;color:var(--text2);}
.pii-icon{color:var(--primary);width:16px;text-align:center;}
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;}
.photo-thumb{aspect-ratio:1;background:var(--surface2);border-radius:6px;overflow:hidden;cursor:pointer;}
.photo-thumb img{width:100%;height:100%;object-fit:cover;}

/* ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ */
.notif-panel{
  position:fixed;top:66px;right:12px;width:340px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);
  z-index:500;display:none;overflow:hidden;max-height:480px;
}
.notif-panel.open{display:block;}
.notif-header{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600;font-size:.85rem;}
.notif-list{overflow-y:auto;max-height:400px;}
.notif-item{
  display:flex;align-items:flex-start;gap:10px;padding:12px 16px;
  cursor:pointer;transition:background .15s;
}
.notif-item:hover{background:var(--surface2);}
.notif-item.unread{background:var(--primary-light);}
.ni-av{width:40px;height:40px;border-radius:50%;object-fit:cover;flex-shrink:0;}
.ni-text{flex:1;font-size:.75rem;line-height:1.45;color:var(--text);}
.ni-text strong{font-weight:600;}
.ni-time{font-size:.65rem;color:var(--text3);margin-top:2px;}

/* ‚îÄ‚îÄ ADD MEMBER MODAL ‚îÄ‚îÄ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(28,26,23,.45);
  backdrop-filter:blur(4px);z-index:800;
  display:flex;align-items:center;justify-content:center;padding:16px;
  opacity:0;pointer-events:none;transition:opacity .2s;
}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal-box{
  background:var(--surface);border-radius:20px;width:100%;max-width:480px;
  box-shadow:var(--shadow-lg);transform:translateY(8px);
  transition:transform .2s;max-height:90vh;overflow-y:auto;
}
.modal-overlay.open .modal-box{transform:translateY(0);}
.modal-header{
  padding:20px 22px 14px;display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--border);
}
.modal-title{font-family:'Fraunces',serif;font-size:1.1rem;}
.modal-close{background:none;border:none;font-size:1.1rem;color:var(--text3);cursor:pointer;line-height:1;transition:color .15s;}
.modal-close:hover{color:var(--text);}
.modal-body{padding:20px 22px;}
.modal-footer{padding:0 22px 20px;display:flex;gap:8px;}
.form-group{margin-bottom:14px;}
.form-label{display:block;font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.07em;color:var(--text2);margin-bottom:5px;}
.form-input,.form-select,.form-textarea{
  width:100%;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  padding:9px 12px;font-family:'Sora',sans-serif;font-size:.83rem;
  color:var(--text);background:var(--surface2);outline:none;transition:border-color .15s;
}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--primary);}
.form-textarea{resize:vertical;min-height:70px;}
.form-row{display:flex;gap:10px;}
.form-row .form-group{flex:1;}
.btn-modal-cancel{
  flex:1;background:none;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  padding:10px;font-family:'Sora',sans-serif;font-size:.82rem;color:var(--text2);
  cursor:pointer;transition:all .15s;
}
.btn-modal-cancel:hover{border-color:var(--primary);color:var(--primary);}
.btn-modal-save{
  flex:2;background:var(--primary);border:none;border-radius:var(--radius-sm);
  padding:10px;font-family:'Sora',sans-serif;font-size:.82rem;font-weight:600;
  color:#fff;cursor:pointer;transition:opacity .15s;
}
.btn-modal-save:hover{opacity:.85;}
.invite-box{
  background:var(--surface2);border:1.5px dashed var(--border2);
  border-radius:var(--radius);padding:14px;margin-top:14px;
}
.invite-box-title{font-size:.72rem;font-weight:600;color:var(--text);margin-bottom:6px;}
.invite-link-row{display:flex;gap:6px;}
.invite-link-input{
  flex:1;background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius-sm);padding:7px 10px;
  font-size:.72rem;color:var(--text2);outline:none;
}
.btn-copy{
  background:var(--primary);color:#fff;border:none;
  border-radius:var(--radius-sm);padding:7px 12px;
  font-size:.72rem;font-weight:600;cursor:pointer;white-space:nowrap;
}

/* ‚îÄ‚îÄ NODE DETAIL PANEL ‚îÄ‚îÄ */
.node-detail-panel{
  position:fixed;right:0;top:var(--nav-h);bottom:0;width:300px;
  background:var(--surface);border-left:1px solid var(--border);
  z-index:90;transform:translateX(100%);transition:transform .25s cubic-bezier(.4,0,.2,1);
  display:flex;flex-direction:column;overflow:hidden;
}
.node-detail-panel.open{transform:translateX(0);}
.ndp-header{
  padding:16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:10px;
}
.ndp-close{background:none;border:none;color:var(--text3);font-size:1rem;cursor:pointer;margin-left:auto;}
.ndp-body{flex:1;overflow-y:auto;padding:16px;}
.ndp-avatar{
  width:72px;height:72px;border-radius:50%;margin:0 auto 12px;
  overflow:hidden;background:var(--surface2);
  display:flex;align-items:center;justify-content:center;font-size:1.8rem;
  border:3px solid var(--primary);
}
.ndp-avatar img{width:100%;height:100%;object-fit:cover;}
.ndp-name{font-family:'Fraunces',serif;font-size:1.1rem;text-align:center;}
.ndp-rel{
  text-align:center;display:inline-block;margin:4px auto 0;
  background:var(--primary-light);color:var(--primary);
  font-size:.68rem;font-weight:600;padding:2px 10px;border-radius:99px;
}
.ndp-rel-wrap{text-align:center;margin-bottom:14px;}
.ndp-detail-row{
  display:flex;align-items:center;gap:8px;padding:8px 0;
  border-bottom:1px solid var(--border);font-size:.76rem;
}
.ndp-detail-row:last-child{border-bottom:none;}
.ndp-detail-label{color:var(--text3);font-size:.68rem;min-width:80px;}
.ndp-actions{padding:14px 16px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:7px;}
.ndp-action-btn{
  display:flex;align-items:center;gap:6px;padding:8px 12px;
  border-radius:var(--radius-sm);font-family:'Sora',sans-serif;
  font-size:.76rem;font-weight:500;cursor:pointer;border:none;transition:all .15s;
}
.ndp-btn-add{background:var(--primary-light);color:var(--primary);}
.ndp-btn-add:hover{background:#d4e8de;}
.ndp-btn-edit{background:var(--surface2);color:var(--text2);border:1px solid var(--border);}
.ndp-btn-edit:hover{border-color:var(--primary);color:var(--primary);}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--text);color:#fff;padding:10px 20px;border-radius:99px;
  font-size:.78rem;font-weight:500;z-index:9999;transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  pointer-events:none;white-space:nowrap;
}
.toast.show{transform:translateX(-50%) translateY(0);}

/* ‚îÄ‚îÄ MOBILE BOTTOM NAV ‚îÄ‚îÄ */
.mobile-bottom-nav{
  display:none;height:56px;background:var(--surface);
  border-top:1px solid var(--border);
  flex-shrink:0;align-items:center;justify-content:space-around;
}
.mbn-item{
  display:flex;flex-direction:column;align-items:center;gap:2px;
  cursor:pointer;padding:4px 16px;border-radius:var(--radius-sm);
  transition:all .15s;color:var(--text3);border:none;background:none;
  font-family:'Sora',sans-serif;
}
.mbn-item.active{color:var(--primary);}
.mbn-icon{font-size:1.1rem;}
.mbn-label{font-size:.55rem;font-weight:500;}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:768px){
  :root{--nav-h:52px;}
  .sidebar{display:none;}
  .topnav-tabs{display:none;}
  .topnav-search{display:none;}
  .feed-right{display:none;}
  .mobile-bottom-nav{display:flex;}
  .profile-grid{grid-template-columns:1fr;}
  .tree-toolbar .tb-btn span{display:none;}
  #tree-canvas-wrap{touch-action:none;}
  .node-detail-panel{width:100%;}
  .modal-box{max-height:85vh;}
}
@media(min-width:769px){
  .tnav-tab.mob-only{display:none;}
}

/* ‚îÄ‚îÄ ZOOM CONTROLS ‚îÄ‚îÄ */
.tree-zoom{
  position:absolute;bottom:20px;right:20px;
  display:flex;flex-direction:column;gap:4px;z-index:10;
}
.tz-btn{
  width:34px;height:34px;background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:.9rem;color:var(--text);transition:all .15s;
}
.tz-btn:hover{border-color:var(--primary);color:var(--primary);}
.tz-label{font-size:.6rem;color:var(--text3);text-align:center;}

/* ‚îÄ‚îÄ RELATION PATH TAG ‚îÄ‚îÄ */
.rel-path-tag{
  position:absolute;background:var(--surface);border:1px solid var(--border);
  border-radius:99px;padding:1px 6px;font-size:.55rem;color:var(--text3);
  pointer-events:none;white-space:nowrap;transform:translate(-50%,-50%);
  box-shadow:0 1px 4px rgba(0,0,0,.08);
}

/* ‚îÄ‚îÄ INVITE PAGE (linked invitation) ‚îÄ‚îÄ */
#invite-banner{
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  padding:12px 16px;display:flex;align-items:center;gap:10px;
  border-radius:var(--radius);margin-bottom:12px;color:#fff;font-size:.78rem;
}
#invite-banner .ib-icon{font-size:1.5rem;}
.ib-text{flex:1;}
.ib-title{font-weight:600;}
.ib-sub{opacity:.8;font-size:.7rem;}
.ib-accept{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.4);color:#fff;border-radius:var(--radius-sm);padding:5px 12px;font-size:.73rem;font-weight:600;cursor:pointer;font-family:'Sora',sans-serif;}

/* ‚îÄ‚îÄ RELATIONSHIP COLORS ‚îÄ‚îÄ */
.rel-self{background:#fef3c7;color:#d97706;}
.rel-parent{background:#dbeafe;color:#2563eb;}
.rel-child{background:#d1fae5;color:#059669;}
.rel-sibling{background:#ede9fe;color:#7c3aed;}
.rel-spouse{background:#fce7f3;color:#db2777;}
.rel-grandparent{background:#e0f2fe;color:#0369a1;}
.rel-uncle-aunt{background:#fef9c3;color:#ca8a04;}
.rel-cousin{background:#f0fdf4;color:#16a34a;}
.rel-inlaw{background:#fdf4ff;color:#9333ea;}

/* ‚îÄ‚îÄ LOADING SPINNER ‚îÄ‚îÄ */
.spinner{
  width:32px;height:32px;border:3px solid var(--border);
  border-top-color:var(--primary);border-radius:50%;
  animation:spin .7s linear infinite;margin:40px auto;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.animate-in{animation:fadeIn .3s ease both;}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-card animate-in">
    <div class="auth-hero">
      <div class="auth-logo">Kin<span>ship</span></div>
      <div class="auth-tagline">Your family, connected forever</div>
    </div>
    <div class="auth-body">
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab('login')">Sign In</div>
        <div class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</div>
      </div>
      <!-- Login -->
      <div id="login-form">
        <div class="inp-group"><label>Email</label><input type="email" id="login-email" placeholder="you@example.com" value="alex@anderson.family"></div>
        <div class="inp-group"><label>Password</label><input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="demo123"></div>
        <button class="btn-auth" onclick="doLogin()">Sign In</button>
        <div class="demo-hint">Demo: <button onclick="demoLogin()">Click here for instant demo login</button></div>
      </div>
      <!-- Signup -->
      <div id="signup-form" style="display:none">
        <div class="form-row" style="display:flex;gap:10px">
          <div class="inp-group" style="flex:1"><label>First Name</label><input id="su-first" placeholder="Alex"></div>
          <div class="inp-group" style="flex:1"><label>Last Name</label><input id="su-last" placeholder="Anderson"></div>
        </div>
        <div class="inp-group"><label>Email</label><input id="su-email" placeholder="you@example.com"></div>
        <div class="inp-group"><label>Password</label><input type="password" id="su-pass" placeholder="Create password"></div>
        <div class="inp-group"><label>Date of Birth</label><input type="date" id="su-dob"></div>
        <button class="btn-auth" onclick="doSignup()">Create Account</button>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <!-- TOP NAV -->
  <nav class="topnav">
    <div class="topnav-logo">Kin<span>ship</span></div>
    <div class="topnav-search">
      <span class="search-icon">üîç</span>
      <input placeholder="Search family members‚Ä¶" oninput="handleSearch(this.value)">
    </div>
    <div class="topnav-tabs">
      <button class="tnav-tab active" onclick="showPage('feed')" data-page="feed"><span class="tnt-icon">üè†</span> Feed</button>
      <button class="tnav-tab" onclick="showPage('tree')" data-page="tree"><span class="tnt-icon">üå≥</span> Family Tree</button>
      <button class="tnav-tab" onclick="showPage('profile')" data-page="profile"><span class="tnt-icon">üë§</span> Profile</button>
    </div>
    <div class="topnav-right">
      <div class="icon-btn" onclick="toggleNotifs()" id="notif-btn">üîî<div class="notif-badge"></div></div>
      <div class="icon-btn" onclick="showPage('messages')">üí¨</div>
      <div class="avatar-btn" onclick="showPage('profile')" id="nav-avatar">
        <img src="" id="nav-avatar-img" alt="">
      </div>
    </div>
  </nav>

  <!-- MAIN LAYOUT -->
  <div class="main-layout">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="main-sidebar">
      <div class="sidebar-section">
        <div class="sidebar-user" onclick="showPage('profile')" id="sidebar-user-info">
          <img class="su-av" id="sidebar-av" src="" alt="">
          <div>
            <div class="su-name" id="sidebar-name"></div>
            <div class="su-handle" id="sidebar-handle"></div>
          </div>
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">Navigation</div>
        <div class="sidebar-nav-item active" onclick="showPage('feed')" data-page="feed"><span class="sni-icon">üè†</span> Home Feed</div>
        <div class="sidebar-nav-item" onclick="showPage('tree')" data-page="tree"><span class="sni-icon">üå≥</span> Family Tree</div>
        <div class="sidebar-nav-item" onclick="showPage('profile')" data-page="profile"><span class="sni-icon">üë§</span> My Profile</div>
        <div class="sidebar-nav-item" onclick="showPage('memories')"><span class="sni-icon">üì∏</span> Memories</div>
        <div class="sidebar-nav-item" onclick="showPage('events')"><span class="sni-icon">üìÖ</span> Family Events</div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-label">Family Members</div>
        <div id="sidebar-family-list"></div>
        <div style="text-align:center;margin-top:8px">
          <button class="btn-invite" onclick="openAddMemberModal(currentUser.id,'child')">+ Add Family Member</button>
        </div>
      </div>
    </aside>

    <!-- CONTENT AREA -->
    <div class="content-area">

      <!-- FEED PAGE -->
      <div class="page active" id="feed-page">
        <div class="feed-layout">
          <div class="feed-main" id="feed-main">
            <!-- Create Post -->
            <div class="create-post animate-in">
              <div class="cp-row">
                <img class="ph-av" id="cp-avatar" src="" alt="" style="border-radius:50%;object-fit:cover;">
                <input class="cp-input" placeholder="Share a family memory‚Ä¶" id="post-input" onfocus="expandPostBox()">
              </div>
              <div class="cp-actions" id="post-actions" style="display:none">
                <button class="cp-action" onclick="createPost('photo')">üì∑ Photo</button>
                <button class="cp-action" onclick="createPost('event')">üìÖ Event</button>
                <button class="cp-action" onclick="createPost('memory')">üí≠ Memory</button>
                <button class="cp-action" onclick="postText()" style="margin-left:auto;background:var(--primary);color:#fff;border-radius:var(--radius-sm);padding:6px 14px;">Post</button>
              </div>
            </div>
            <!-- Stories -->
            <div class="stories-row" id="stories-row"></div>
            <!-- Posts -->
            <div id="posts-container"></div>
          </div>
          <aside class="feed-right">
            <div class="widget" id="invite-widget">
              <div class="widget-title">Invite Family</div>
              <p style="font-size:.73rem;color:var(--text2);margin-bottom:10px">Invite family members to join Kinship and build the tree together.</p>
              <div class="invite-link-row">
                <input class="invite-link-input" id="invite-link-display" readonly value="">
                <button class="btn-copy" onclick="copyInviteLink()">Copy</button>
              </div>
            </div>
            <div class="widget" id="birthdays-widget">
              <div class="widget-title">üéÇ Upcoming Birthdays</div>
              <div id="bday-list"></div>
            </div>
            <div class="widget">
              <div class="widget-title">Suggested Connections</div>
              <div id="suggestions-list"></div>
            </div>
          </aside>
        </div>
      </div>

      <!-- TREE PAGE -->
      <div class="page" id="tree-page">
        <div class="tree-toolbar">
          <div class="tree-toolbar-title">üå≥ Family Tree</div>
          <div id="tree-view-label" style="font-size:.72rem;color:var(--text3);margin-right:4px;"></div>
          <button class="tb-btn tb-btn-outline" onclick="fitTreeToScreen()"><span>‚äû</span> <span>Fit All</span></button>
          <button class="tb-btn tb-btn-outline" onclick="resetTreeZoom()"><span>‚ü≥</span> <span>Reset</span></button>
          <button class="tb-btn tb-btn-primary" onclick="openAddMemberModal(currentUser.id,'child')"><span>+</span> <span>Add Member</span></button>
        </div>
        <div id="tree-canvas-wrap">
          <div id="tree-canvas">
            <svg id="tree-svg"></svg>
          </div>
          <div class="tree-zoom">
            <div class="tz-btn" onclick="treeZoom(.15)">+</div>
            <div class="tz-label" id="tz-label">100%</div>
            <div class="tz-btn" onclick="treeZoom(-.15)">‚àí</div>
            <div class="tz-btn" onclick="fitTreeToScreen()">‚äû</div>
          </div>
        </div>
      </div>

      <!-- PROFILE PAGE -->
      <div class="page" id="profile-page">
        <div style="overflow-y:auto;flex:1;">
          <div class="profile-cover" id="profile-cover">
            <div class="profile-cover-edit" onclick="editCover()">‚úèÔ∏è Edit Cover</div>
          </div>
          <div class="profile-info-row">
            <div class="profile-avatar-wrap">
              <div class="profile-avatar" id="profile-avatar-wrap">
                <img id="profile-avatar-img" src="" alt="">
              </div>
            </div>
            <div class="profile-details">
              <div class="profile-name" id="profile-name-display"></div>
              <div class="profile-handle" id="profile-handle-display"></div>
              <div class="profile-stats">
                <div class="pstat"><div class="pstat-n" id="ps-posts">0</div><div class="pstat-l">Posts</div></div>
                <div class="pstat"><div class="pstat-n" id="ps-family">0</div><div class="pstat-l">Family</div></div>
                <div class="pstat"><div class="pstat-n" id="ps-photos">0</div><div class="pstat-l">Photos</div></div>
              </div>
            </div>
            <div class="profile-actions">
              <button class="btn-profile-action btn-pa-primary" onclick="openEditProfile()">‚úèÔ∏è Edit Profile</button>
              <button class="btn-profile-action btn-pa-outline" onclick="openAddMemberModal(currentUser.id,'child')">+ Add Member</button>
            </div>
          </div>
          <div class="profile-body">
            <div class="profile-grid">
              <div>
                <div class="profile-card">
                  <div class="profile-card-title">About</div>
                  <div class="profile-info-item"><span class="pii-icon">üè†</span><span id="pi-location"></span></div>
                  <div class="profile-info-item"><span class="pii-icon">üíº</span><span id="pi-occ"></span></div>
                  <div class="profile-info-item"><span class="pii-icon">üéÇ</span><span id="pi-dob"></span></div>
                  <div class="profile-info-item"><span class="pii-icon">üåø</span><span id="pi-family-side"></span></div>
                </div>
                <div class="profile-card">
                  <div class="profile-card-title">Family Members <span style="color:var(--primary);cursor:pointer;font-size:.72rem" onclick="showPage('tree')">View Tree ‚Üí</span></div>
                  <div id="profile-family-list"></div>
                </div>
              </div>
              <div>
                <div class="profile-card" id="my-posts-section">
                  <div class="profile-card-title">Posts</div>
                  <div id="my-posts-list"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- end content-area -->
  </div><!-- end main-layout -->

  <!-- MOBILE BOTTOM NAV -->
  <div class="mobile-bottom-nav" id="mobile-nav">
    <button class="mbn-item active" onclick="showPage('feed')" data-mob="feed"><span class="mbn-icon">üè†</span><span class="mbn-label">Feed</span></button>
    <button class="mbn-item" onclick="showPage('tree')" data-mob="tree"><span class="mbn-icon">üå≥</span><span class="mbn-label">Tree</span></button>
    <button class="mbn-item" onclick="showPage('profile')" data-mob="profile"><span class="mbn-icon">üë§</span><span class="mbn-label">Profile</span></button>
    <button class="mbn-item" onclick="toggleNotifs()"><span class="mbn-icon">üîî</span><span class="mbn-label">Alerts</span></button>
  </div>
</div><!-- end #app -->

<!-- NOTIFICATION PANEL -->
<div class="notif-panel" id="notif-panel">
  <div class="notif-header">Notifications</div>
  <div class="notif-list" id="notif-list"></div>
</div>

<!-- NODE DETAIL PANEL -->
<div class="node-detail-panel" id="node-detail-panel">
  <div class="ndp-header">
    <div style="font-size:.8rem;font-weight:600">Family Member</div>
    <button class="ndp-close" onclick="closeNodeDetail()">‚úï</button>
  </div>
  <div class="ndp-body">
    <div class="ndp-avatar" id="ndp-avatar"></div>
    <div class="ndp-name" id="ndp-name"></div>
    <div class="ndp-rel-wrap"><span class="ndp-rel" id="ndp-rel"></span></div>
    <div id="ndp-rows"></div>
  </div>
  <div class="ndp-actions" id="ndp-actions"></div>
</div>

<!-- ADD MEMBER MODAL -->
<div class="modal-overlay" id="add-modal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="add-modal-title">Add Family Member</div>
      <button class="modal-close" onclick="closeAddModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">First Name *</label><input class="form-input" id="am-first" placeholder="First"></div>
        <div class="form-group"><label class="form-label">Last Name</label><input class="form-input" id="am-last" placeholder="Last"></div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Gender</label>
          <select class="form-select" id="am-gender">
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Birth Year</label><input class="form-input" id="am-birth" type="number" placeholder="1985" min="1900" max="2025"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Relation to <span id="am-ref-name">you</span></label>
        <select class="form-select" id="am-relation">
          <option value="father">Father</option>
          <option value="mother">Mother</option>
          <option value="spouse">Spouse / Partner</option>
          <option value="son">Son</option>
          <option value="daughter">Daughter</option>
          <option value="brother">Brother</option>
          <option value="sister">Sister</option>
          <option value="grandfather_paternal">Paternal Grandfather</option>
          <option value="grandmother_paternal">Paternal Grandmother</option>
          <option value="grandfather_maternal">Maternal Grandfather</option>
          <option value="grandmother_maternal">Maternal Grandmother</option>
          <option value="uncle_paternal">Paternal Uncle</option>
          <option value="aunt_paternal">Paternal Aunt</option>
          <option value="uncle_maternal">Maternal Uncle</option>
          <option value="aunt_maternal">Maternal Aunt</option>
          <option value="cousin">Cousin</option>
          <option value="nephew">Nephew</option>
          <option value="niece">Niece</option>
          <option value="stepfather">Stepfather</option>
          <option value="stepmother">Stepmother</option>
          <option value="second_spouse">Second Spouse</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Occupation</label><input class="form-input" id="am-occ" placeholder="e.g. Engineer"></div>
        <div class="form-group"><label class="form-label">Location</label><input class="form-input" id="am-location" placeholder="City, Country"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Short Bio</label>
        <textarea class="form-textarea" id="am-bio" placeholder="A little about them‚Ä¶"></textarea>
      </div>
      <div class="invite-box">
        <div class="invite-box-title">üì® Send Invitation Link</div>
        <p style="font-size:.7rem;color:var(--text2);margin-bottom:8px">They can click this link to create their own account and be automatically connected.</p>
        <div class="invite-link-row">
          <input class="invite-link-input" id="am-invite-link" readonly>
          <button class="btn-copy" onclick="copyInvite()">Copy</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal-cancel" onclick="closeAddModal()">Cancel</button>
      <button class="btn-modal-save" onclick="saveNewMember()">Add to Family Tree</button>
    </div>
  </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div class="modal-overlay" id="edit-profile-modal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">Edit Profile</div>
      <button class="modal-close" onclick="document.getElementById('edit-profile-modal').classList.remove('open')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">First Name</label><input class="form-input" id="ep-first"></div>
        <div class="form-group"><label class="form-label">Last Name</label><input class="form-input" id="ep-last"></div>
      </div>
      <div class="form-group"><label class="form-label">Bio</label><textarea class="form-textarea" id="ep-bio"></textarea></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Occupation</label><input class="form-input" id="ep-occ"></div>
        <div class="form-group"><label class="form-label">Location</label><input class="form-input" id="ep-location"></div>
      </div>
      <div class="form-group"><label class="form-label">Date of Birth</label><input class="form-input" type="date" id="ep-dob"></div>
      <div class="form-group"><label class="form-label">Profile Photo URL (or emoji)</label><input class="form-input" id="ep-photo" placeholder="https://‚Ä¶ or leave blank for emoji"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal-cancel" onclick="document.getElementById('edit-profile-modal').classList.remove('open')">Cancel</button>
      <button class="btn-modal-save" onclick="saveEditProfile()">Save Changes</button>
    </div>
  </div>
</div>

<!-- POST MODAL -->
<div class="modal-overlay" id="post-modal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">Create Post</div>
      <button class="modal-close" onclick="document.getElementById('post-modal').classList.remove('open')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="cp-row" style="margin-bottom:14px">
        <img id="pm-avatar" style="width:40px;height:40px;border-radius:50%;object-fit:cover" src="" alt="">
        <div style="font-size:.82rem;font-weight:600" id="pm-name"></div>
      </div>
      <textarea class="form-textarea" id="pm-text" placeholder="What's on your mind?" style="min-height:100px;font-size:.9rem"></textarea>
      <div class="form-group" style="margin-top:10px">
        <label class="form-label">Post Type</label>
        <select class="form-select" id="pm-type">
          <option value="update">Status Update</option>
          <option value="memory">Memory</option>
          <option value="photo">Photo / Image</option>
          <option value="milestone">Family Milestone</option>
          <option value="announcement">Announcement</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal-cancel" onclick="document.getElementById('post-modal').classList.remove('open')">Cancel</button>
      <button class="btn-modal-save" onclick="submitPost()">Share Post</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA MODEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let DB = {
  users: {},     // id -> user object
  posts: [],     // post objects
  notifications: [],
  inviteLinks: {}  // token -> { inviterId, relation, targetName }
};

let currentUser = null;
let uid = 100;
let pid = 1;

function mkUID(){ return 'u' + (uid++); }

// Gender-based emoji avatar
function genderEmoji(g){ return g==='female'?'üë©':g==='male'?'üë®':'üßë'; }

// ‚îÄ‚îÄ‚îÄ RELATIONSHIP ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Every user stores: parentIds[], childIds[], spouseIds[], siblingIds[]
// Additional role tags for specific relationships stored in relationships{}
// relationships[userId] = { relType, side }

// Compute relationship of personB to personA (viewer)
function computeRelation(viewerId, targetId) {
  if(viewerId === targetId) return 'You';
  const viewer = DB.users[viewerId];
  const target = DB.users[targetId];
  if(!viewer || !target) return 'Family Member';

  // Direct relationships
  if(viewer.parentIds.includes(targetId)) {
    const rel = viewer.relationships[targetId];
    if(rel) return rel.relType === 'father' ? 'Father' : rel.relType === 'mother' ? 'Mother' : rel.relType === 'stepfather' ? 'Stepfather' : rel.relType === 'stepmother' ? 'Stepmother' : 'Parent';
    return target.gender === 'male' ? 'Father' : 'Mother';
  }
  if(viewer.spouseIds.includes(targetId)) {
    return target.gender === 'male' ? 'Husband' : target.gender === 'female' ? 'Wife' : 'Spouse';
  }
  if(viewer.childIds.includes(targetId)) {
    return target.gender === 'male' ? 'Son' : target.gender === 'female' ? 'Daughter' : 'Child';
  }
  if(viewer.siblingIds.includes(targetId)) {
    return target.gender === 'male' ? 'Brother' : target.gender === 'female' ? 'Sister' : 'Sibling';
  }

  // One hop through parents
  for(const parentId of viewer.parentIds) {
    const parent = DB.users[parentId];
    if(!parent) continue;
    const prel = viewer.relationships[parentId];
    const side = prel ? (prel.relType==='father'?'paternal':'maternal') : 'paternal';

    // Grandparent
    if(parent.parentIds.includes(targetId)) {
      if(side==='paternal') return target.gender==='male'?'Paternal Grandfather':'Paternal Grandmother';
      return target.gender==='male'?'Maternal Grandfather':'Maternal Grandmother';
    }
    // Parent's spouse = step parent
    if(parent.spouseIds.includes(targetId) && !viewer.parentIds.includes(targetId)) {
      return target.gender==='male'?'Stepfather':'Stepmother';
    }
    // Sibling (same parent)
    if(parent.childIds.includes(targetId) && targetId !== viewerId) {
      if(!viewer.siblingIds.includes(targetId))
        return target.gender==='male'?'Half-Brother':'Half-Sister';
    }
    // Uncle/Aunt (parent's sibling)
    if(parent.siblingIds.includes(targetId)) {
      if(side==='paternal') return target.gender==='male'?'Paternal Uncle':'Paternal Aunt';
      return target.gender==='male'?'Maternal Uncle':'Maternal Aunt';
    }
  }

  // One hop through children
  for(const cid of viewer.childIds) {
    const child = DB.users[cid];
    if(!child) continue;
    if(child.spouseIds.includes(targetId)) {
      return child.gender==='male'?'Daughter-in-law':'Son-in-law';
    }
    if(child.childIds.includes(targetId)) return target.gender==='male'?'Grandson':'Granddaughter';
    if(child.siblingIds.includes(targetId)) {
      // nephew/niece
      return target.gender==='male'?'Nephew':'Niece';
    }
  }

  // One hop through siblings
  for(const sibId of viewer.siblingIds) {
    const sib = DB.users[sibId];
    if(!sib) continue;
    if(sib.spouseIds.includes(targetId)) {
      return sibId === targetId ? 'Sibling' : (sib.gender==='male'?'Sister-in-law':'Brother-in-law');
    }
    if(sib.childIds.includes(targetId)) return target.gender==='male'?'Nephew':'Niece';
  }

  // Two hops: grandparent's children = uncle/aunt
  for(const parentId of viewer.parentIds) {
    const parent = DB.users[parentId];
    if(!parent) continue;
    const prel = viewer.relationships[parentId];
    const side = prel ? (prel.relType==='father'?'paternal':'maternal') : 'paternal';
    for(const gpId of parent.parentIds) {
      const gp = DB.users[gpId];
      if(!gp) continue;
      if(gp.childIds.includes(targetId)) {
        // Parent's sibling
        if(side==='paternal') return target.gender==='male'?'Paternal Uncle':'Paternal Aunt';
        return target.gender==='male'?'Maternal Uncle':'Maternal Aunt';
      }
    }
    // Uncle/aunt's children = cousins
    for(const uncleId of parent.siblingIds) {
      const uncle = DB.users[uncleId];
      if(!uncle) continue;
      if(uncle.childIds.includes(targetId)) return 'Cousin';
    }
  }

  // Spouse's parents = in-laws
  for(const spouseId of viewer.spouseIds) {
    const spouse = DB.users[spouseId];
    if(!spouse) continue;
    if(spouse.parentIds.includes(targetId)) {
      return target.gender==='male'?'Father-in-law':'Mother-in-law';
    }
    if(spouse.siblingIds.includes(targetId)) {
      return target.gender==='male'?'Brother-in-law':'Sister-in-law';
    }
    for(const spChildId of spouse.childIds) {
      if(spChildId === targetId && !viewer.childIds.includes(targetId)) {
        return target.gender==='male'?'Stepson':'Stepdaughter';
      }
    }
  }

  return 'Family Member';
}

function getRelationClass(rel) {
  rel = rel.toLowerCase();
  if(rel.includes('father') || rel.includes('mother')) return 'rel-parent';
  if(rel.includes('son') || rel.includes('daughter')) return 'rel-child';
  if(rel.includes('brother') || rel.includes('sister')) return 'rel-sibling';
  if(rel.includes('husband') || rel.includes('wife') || rel.includes('spouse')) return 'rel-spouse';
  if(rel.includes('grandfather') || rel.includes('grandmother')) return 'rel-grandparent';
  if(rel.includes('uncle') || rel.includes('aunt')) return 'rel-uncle-aunt';
  if(rel.includes('cousin')) return 'rel-cousin';
  if(rel.includes('in-law') || rel.includes('step')) return 'rel-inlaw';
  if(rel==='you') return 'rel-self';
  return '';
}

// ‚îÄ‚îÄ‚îÄ LINK HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function linkRelationship(adderId, newId, relType) {
  const adder = DB.users[adderId];
  const newPerson = DB.users[newId];
  if(!adder || !newPerson) return;

  // Store the explicit relation
  adder.relationships[newId] = { relType, side: getSide(relType) };
  newPerson.relationships[adderId] = { relType: inverseRel(relType, adder.gender), side: getSide(relType) };

  switch(relType) {
    case 'father': case 'mother': case 'stepfather': case 'stepmother':
      if(!adder.parentIds.includes(newId)) adder.parentIds.push(newId);
      if(!newPerson.childIds.includes(adderId)) newPerson.childIds.push(adderId);
      // If adder has spouse and this is a parent, link parent to spouse too
      for(const spouseId of adder.spouseIds) {
        const sp = DB.users[spouseId];
        if(sp && !sp.childIds.includes(adderId)) {
          // Don't auto-link, just note
        }
      }
      break;
    case 'spouse': case 'second_spouse':
      if(!adder.spouseIds.includes(newId)) adder.spouseIds.push(newId);
      if(!newPerson.spouseIds.includes(adderId)) newPerson.spouseIds.push(adderId);
      // When someone adds a spouse, they become parent to each other's children
      for(const cid of adder.childIds) {
        const child = DB.users[cid];
        if(child && !child.parentIds.includes(newId)) {
          child.parentIds.push(newId);
          newPerson.childIds.push(cid);
          child.relationships[newId] = { relType: adder.gender==='male'?'mother':'father', side:'both' };
        }
      }
      break;
    case 'son': case 'daughter':
      if(!adder.childIds.includes(newId)) adder.childIds.push(newId);
      if(!newPerson.parentIds.includes(adderId)) newPerson.parentIds.push(adderId);
      // Auto-add as sibling to existing children
      for(const existingChildId of adder.childIds) {
        if(existingChildId !== newId) {
          const ec = DB.users[existingChildId];
          if(ec && !ec.siblingIds.includes(newId)) {
            ec.siblingIds.push(newId);
            newPerson.siblingIds.push(existingChildId);
          }
        }
      }
      // If adder has spouse, add spouse as parent
      for(const spouseId of adder.spouseIds) {
        const sp = DB.users[spouseId];
        if(sp && !newPerson.parentIds.includes(spouseId)) {
          newPerson.parentIds.push(spouseId);
          if(!sp.childIds.includes(newId)) sp.childIds.push(newId);
          newPerson.relationships[spouseId] = { relType: sp.gender==='male'?'father':'mother', side:'both' };
          sp.relationships[newId] = { relType: relType, side:'both' };
        }
      }
      break;
    case 'brother': case 'sister':
      if(!adder.siblingIds.includes(newId)) adder.siblingIds.push(newId);
      if(!newPerson.siblingIds.includes(adderId)) newPerson.siblingIds.push(adderId);
      // Share parents
      for(const parentId of adder.parentIds) {
        if(!newPerson.parentIds.includes(parentId)) {
          newPerson.parentIds.push(parentId);
          const par = DB.users[parentId];
          if(par && !par.childIds.includes(newId)) par.childIds.push(newId);
        }
      }
      break;
    case 'grandfather_paternal': case 'grandfather_maternal':
    case 'grandmother_paternal': case 'grandmother_maternal':
      // Find or note that this is a grandparent
      if(!adder.grandparentIds) adder.grandparentIds = [];
      if(!adder.grandparentIds.includes(newId)) adder.grandparentIds.push(newId);
      if(!newPerson.grandchildIds) newPerson.grandchildIds = [];
      if(!newPerson.grandchildIds.includes(adderId)) newPerson.grandchildIds.push(adderId);
      // Link to the relevant parent
      const side = relType.includes('paternal') ? 'paternal' : 'maternal';
      for(const parentId of adder.parentIds) {
        const par = DB.users[parentId];
        const pRel = adder.relationships[parentId];
        const parSide = pRel ? (pRel.relType==='father'?'paternal':'maternal') : null;
        if(parSide === side) {
          if(!par.parentIds.includes(newId)) par.parentIds.push(newId);
          if(!newPerson.childIds.includes(parentId)) newPerson.childIds.push(parentId);
        }
      }
      break;
    case 'uncle_paternal': case 'uncle_maternal':
    case 'aunt_paternal': case 'aunt_maternal':
      if(!adder.uncleAuntIds) adder.uncleAuntIds = [];
      if(!adder.uncleAuntIds.includes(newId)) adder.uncleAuntIds.push(newId);
      // Link as sibling of parent
      const uside = relType.includes('paternal') ? 'paternal' : 'maternal';
      for(const parentId of adder.parentIds) {
        const par = DB.users[parentId];
        const pRel2 = adder.relationships[parentId];
        const pSide = pRel2 ? (pRel2.relType==='father'?'paternal':'maternal') : null;
        if(pSide === uside) {
          if(!par.siblingIds.includes(newId)) par.siblingIds.push(newId);
          if(!newPerson.siblingIds.includes(parentId)) newPerson.siblingIds.push(parentId);
        }
      }
      break;
    case 'cousin': case 'nephew': case 'niece':
      // Just store relation
      break;
  }
}

function getSide(relType) {
  if(relType.includes('paternal') || relType==='father' || relType==='stepfather') return 'paternal';
  if(relType.includes('maternal') || relType==='mother' || relType==='stepmother') return 'maternal';
  return 'both';
}

function inverseRel(rel, gender) {
  const map = {
    father:'son/daughter', mother:'son/daughter',
    son:'father', daughter:'mother',
    brother:'brother/sister', sister:'brother/sister',
    spouse:'spouse', second_spouse:'spouse',
    grandfather_paternal:'grandchild', grandmother_paternal:'grandchild',
    grandfather_maternal:'grandchild', grandmother_maternal:'grandchild',
  };
  return map[rel] || 'family';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEED DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function seedData() {
  function mkUser(d) {
    const id = d.id || mkUID();
    DB.users[id] = {
      id, first:d.first, last:d.last, gender:d.gender||'male',
      email:d.email||'', password:d.password||'demo123',
      birth:d.birth||null, occ:d.occ||'', location:d.location||'',
      bio:d.bio||'', photo:d.photo||'',
      parentIds:[], childIds:[], spouseIds:[], siblingIds:[],
      grandparentIds:[], grandchildIds:[], uncleAuntIds:[],
      relationships:{}, posts:[],
      joined: new Date().toISOString()
    };
    return id;
  }

  // Generation 1 (great-grandparents area / grandparents)
  const gpHarold = mkUser({id:'u_harold', first:'Harold', last:'Anderson', gender:'male', birth:1940, occ:'Retired Engineer', location:'Boston, MA', bio:'Patriarch of the Anderson family'});
  const gpEleanor = mkUser({id:'u_eleanor', first:'Eleanor', last:'Anderson', gender:'female', birth:1943, occ:'Retired Teacher', location:'Boston, MA', bio:'Loves gardening and cooking'});
  const gpJames = mkUser({id:'u_james', first:'James', last:'Carter', gender:'male', birth:1938, occ:'Retired Farmer', location:'Vermont', bio:'Patriarch of Carter family'});
  const gpRuth = mkUser({id:'u_ruth', first:'Ruth', last:'Carter', gender:'female', birth:1942, occ:'Retired Nurse', location:'Vermont', bio:'Wonderful grandmother'});

  // Generation 2
  const dadDavid = mkUser({id:'u_david', first:'David', last:'Anderson', gender:'male', birth:1968, occ:'Architect', location:'Chicago, IL', bio:'Loves hiking and photography'});
  const momSarah = mkUser({id:'u_sarah', first:'Sarah', last:'Anderson', gender:'female', birth:1970, occ:'Lawyer', location:'Chicago, IL', bio:'Passionate about family history'});
  const uncleMartin = mkUser({id:'u_martin', first:'Martin', last:'Anderson', gender:'male', birth:1971, occ:'Doctor', location:'New York, NY', bio:'Pediatric surgeon'});
  const auntLinda = mkUser({id:'u_linda', first:'Linda', last:'Carter', gender:'female', birth:1972, occ:'Nurse', location:'Vermont', bio:'Loves arts and crafts'});

  // Generation 3 ‚Äì main user
  const alex = mkUser({id:'u_alex', first:'Alex', last:'Anderson', gender:'male', birth:1995, email:'alex@anderson.family', password:'demo123', occ:'UX Designer', location:'San Francisco, CA', bio:'Building family connections through Kinship'});
  const priya = mkUser({id:'u_priya', first:'Priya', last:'Sharma', gender:'female', birth:1996, occ:'Product Manager', location:'San Francisco, CA', bio:'Love exploring the world with family'});
  const emma = mkUser({id:'u_emma', first:'Emma', last:'Anderson', gender:'female', birth:1998, occ:'Photographer', location:'Chicago, IL', bio:'Capturing family moments'});
  const cousinBen = mkUser({id:'u_ben', first:'Ben', last:'Anderson', gender:'male', birth:1993, occ:'Software Engineer', location:'New York, NY', bio:'Tech enthusiast'});

  // Generation 4
  const leo = mkUser({id:'u_leo', first:'Leo', last:'Anderson', gender:'male', birth:2020, occ:'Student', location:'San Francisco, CA'});
  const mia = mkUser({id:'u_mia', first:'Mia', last:'Anderson', gender:'female', birth:2022, occ:'Student', location:'San Francisco, CA'});

  // Wire up relationships ‚Äî starting from Alex's perspective
  // Grandparents paternal
  linkRelationship(dadDavid, gpHarold, 'father');
  linkRelationship(dadDavid, gpEleanor, 'mother');
  // Grandparents maternal
  linkRelationship(momSarah, gpJames, 'father');
  linkRelationship(momSarah, gpRuth, 'mother');
  // Harold & Eleanor spouses
  DB.users[gpHarold].spouseIds = [gpEleanor];
  DB.users[gpEleanor].spouseIds = [gpHarold];
  DB.users[gpJames].spouseIds = [gpRuth];
  DB.users[gpRuth].spouseIds = [gpJames];
  // Martin = David's brother
  linkRelationship(dadDavid, uncleMartin, 'brother');
  // Linda = Sarah's sister
  linkRelationship(momSarah, auntLinda, 'sister');
  // David & Sarah married
  linkRelationship(dadDavid, momSarah, 'spouse');
  // Alex's parents
  linkRelationship(alex, dadDavid, 'father');
  linkRelationship(alex, momSarah, 'mother');
  // Alex's spouse
  linkRelationship(alex, priya, 'spouse');
  // Emma is Alex's sister
  linkRelationship(alex, emma, 'sister');
  // Ben is Martin's son (cousin to Alex)
  linkRelationship(uncleMartin, cousinBen, 'son');
  // Alex's children
  linkRelationship(alex, leo, 'son');
  linkRelationship(alex, mia, 'daughter');

  // Seed posts
  DB.posts = [
    { id:'post1', authorId:'u_alex', type:'memory', text:"Just discovered some old family photos from the 1960s ‚Äî Grandpa Harold and Grandma Eleanor looked so young! üì∏", timestamp: Date.now() - 3600000*2, likes:7, liked:false, comments:3, shares:1 },
    { id:'post2', authorId:'u_sarah', type:'milestone', text:"Proud to announce that our little Mia just said her first word: 'Mama'! üéâ The whole family is thrilled! Tag someone who would love this news!", timestamp: Date.now() - 3600000*8, likes:14, liked:false, comments:6, shares:2 },
    { id:'post3', authorId:'u_david', type:'update', text:"Family barbecue this weekend at our place in Chicago! Who's coming? üçñ @Emma @Martin @Linda ‚Äî don't forget to bring the potato salad!", timestamp: Date.now() - 3600000*26, likes:9, liked:false, comments:4, shares:0 },
    { id:'post4', authorId:'u_emma', type:'photo', text:"Throwback to last Christmas ‚Äî the whole Anderson-Carter family together. Miss everyone so much! ‚ù§Ô∏è", timestamp: Date.now() - 86400000*3, likes:21, liked:false, comments:8, shares:3 },
    { id:'post5', authorId:'u_priya', type:'announcement', text:"Excited to share that I've started a family recipe book project! If anyone has old family recipes they'd like to contribute, please DM me üç≤üìó", timestamp: Date.now() - 86400000*5, likes:11, liked:false, comments:5, shares:1 },
  ];

  // Seed notifications
  DB.notifications = [
    { id:'n1', type:'family_add', from:'u_sarah', text:'added you to the family tree', time: Date.now()-1800000, unread:true },
    { id:'n2', type:'like', from:'u_emma', text:'liked your memory post', time: Date.now()-7200000, unread:true },
    { id:'n3', type:'comment', from:'u_david', text:'commented on your post: "Great memories!"', time: Date.now()-86400000, unread:false },
    { id:'n4', type:'invite', from:'u_martin', text:'invited Cousin Ben to join Kinship', time: Date.now()-86400000*2, unread:false },
    { id:'n5', type:'birthday', from:null, text:"It's Grandma Eleanor's birthday today! üéÇ", time: Date.now()-3600000, unread:true },
  ];

  return 'u_alex';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',i===(tab==='login'?0:1)));
  document.getElementById('login-form').style.display = tab==='login'?'block':'none';
  document.getElementById('signup-form').style.display = tab==='signup'?'block':'none';
}

function demoLogin() { loginUser('u_alex'); }

function doLogin() {
  const email = document.getElementById('login-email').value;
  const pass   = document.getElementById('login-pass').value;
  const found = Object.values(DB.users).find(u=>u.email===email && u.password===pass);
  if(found) loginUser(found.id);
  else showToast('Invalid email or password');
}

function doSignup() {
  const first = document.getElementById('su-first').value.trim();
  const last  = document.getElementById('su-last').value.trim();
  const email = document.getElementById('su-email').value.trim();
  const pass  = document.getElementById('su-pass').value;
  const dob   = document.getElementById('su-dob').value;
  if(!first||!email||!pass){ showToast('Please fill required fields'); return; }
  if(Object.values(DB.users).find(u=>u.email===email)){ showToast('Email already registered'); return; }
  const id = mkUID();
  DB.users[id] = {
    id, first, last, gender:'other', email, password:pass,
    birth: dob ? new Date(dob).getFullYear() : null,
    occ:'', location:'', bio:'', photo:'',
    parentIds:[], childIds:[], spouseIds:[], siblingIds:[],
    grandparentIds:[], grandchildIds:[], uncleAuntIds:[],
    relationships:{}, posts:[], joined: new Date().toISOString()
  };
  loginUser(id);
}

function loginUser(userId) {
  currentUser = DB.users[userId];
  document.getElementById('auth-screen').style.display='none';
  document.getElementById('app').classList.add('visible');
  initApp();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initApp() {
  updateNavUser();
  renderSidebar();
  renderFeed();
  renderProfile();
  buildFamilyTree();
  generateInviteLink();
  renderNotifications();
  renderBirthdays();
  showPage('feed');
}

function updateNavUser() {
  const u = currentUser;
  const name = u.first + ' ' + u.last;
  document.getElementById('nav-avatar-img').src = u.photo || '';
  document.getElementById('nav-avatar-img').alt = name;
  if(!u.photo) document.getElementById('nav-avatar').innerHTML = `<div style="width:36px;height:36px;border-radius:50%;background:var(--primary-light);display:flex;align-items:center;justify-content:center;font-size:1rem">${genderEmoji(u.gender)}</div>`;
  document.getElementById('sidebar-name').textContent = name;
  document.getElementById('sidebar-handle').textContent = '@' + u.first.toLowerCase() + u.last.toLowerCase();
  const siAv = document.getElementById('sidebar-av');
  siAv.src = u.photo || '';
  if(!u.photo) siAv.style.display='none', document.getElementById('sidebar-user-info').querySelector('.su-av').outerHTML=`<div class="su-av" style="display:flex;align-items:center;justify-content:center;background:var(--primary-light);font-size:1.2rem">${genderEmoji(u.gender)}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(name) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('[data-page]').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('[data-mob]').forEach(t=>t.classList.remove('active'));
  const pg = document.getElementById(name+'-page');
  if(pg) pg.classList.add('active');
  document.querySelectorAll(`[data-page="${name}"]`).forEach(t=>t.classList.add('active'));
  document.querySelectorAll(`[data-mob="${name}"]`).forEach(t=>t.classList.add('active'));
  if(name==='tree') { setTimeout(()=>{buildFamilyTree();fitTreeToScreen();},100); }
  if(name==='profile') renderProfile();
  closeNodeDetail();
  document.getElementById('notif-panel').classList.remove('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSidebar() {
  const u = currentUser;
  const list = document.getElementById('sidebar-family-list');
  list.innerHTML = '';
  const allRelated = getAllRelated(u.id);
  allRelated.slice(0,8).forEach(rid => {
    const r = DB.users[rid];
    const rel = computeRelation(u.id, rid);
    const div = document.createElement('div');
    div.className = 'family-quick';
    div.innerHTML = `
      <div class="fq-av" style="background:${r.gender==='male'?'var(--male)':'var(--female)'};display:flex;align-items:center;justify-content:center;font-size:1rem">${r.photo?'':'<img src="'+r.photo+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%">'}${r.photo?'':genderEmoji(r.gender)}</div>
      <div class="fq-info"><div class="fq-name">${r.first} ${r.last}</div><div class="fq-rel">${rel}</div></div>`;
    div.onclick = () => { openNodeDetailById(rid); showPage('tree'); };
    list.appendChild(div);
  });
}

function getAllRelated(uid) {
  const u = DB.users[uid];
  if(!u) return [];
  const set = new Set([
    ...u.parentIds, ...u.childIds, ...u.spouseIds, ...u.siblingIds,
    ...(u.grandparentIds||[]), ...(u.uncleAuntIds||[])
  ]);
  // Also add children of parents (siblings we might have missed)
  u.parentIds.forEach(pid => {
    const p = DB.users[pid];
    if(p) p.childIds.forEach(cid => { if(cid!==uid) set.add(cid); });
  });
  return [...set];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFeed() {
  renderStories();
  renderPosts();
  // Set CP avatar
  const u = currentUser;
  const cpAv = document.getElementById('cp-avatar');
  cpAv.src = u.photo || '';
  cpAv.style.width = '40px'; cpAv.style.height = '40px';
  if(!u.photo) { cpAv.style.display='none'; }
}

function renderStories() {
  const row = document.getElementById('stories-row');
  row.innerHTML = `
    <div class="story-card add-story">
      <div class="add-story-icon">+</div>
      <div class="story-name">Add Story</div>
    </div>`;
  const related = getAllRelated(currentUser.id);
  [currentUser.id, ...related].slice(0,8).forEach(uid => {
    const u = DB.users[uid];
    if(!u) return;
    const sc = document.createElement('div');
    sc.className = 'story-card';
    sc.style.background = `linear-gradient(135deg, hsl(${(uid.charCodeAt(1)||1)*40%360},60%,40%), hsl(${(uid.charCodeAt(2)||2)*50%360},60%,55%))`;
    sc.innerHTML = `
      <div class="story-av"><div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--primary-light);border-radius:50%;font-size:1rem">${genderEmoji(u.gender)}</div></div>
      <div class="story-name">${u.first}</div>`;
    row.appendChild(sc);
  });
}

function renderPosts() {
  const container = document.getElementById('posts-container');
  container.innerHTML = '';
  const sortedPosts = [...DB.posts].sort((a,b)=>b.timestamp-a.timestamp);
  sortedPosts.forEach(post => {
    const author = DB.users[post.authorId];
    if(!author) return;
    const rel = computeRelation(currentUser.id, post.authorId);
    const timeAgo = formatTimeAgo(post.timestamp);
    const typeEmoji = {update:'üí¨',memory:'üí≠',photo:'üì∑',milestone:'üéâ',announcement:'üì¢'}[post.type]||'üí¨';
    const div = document.createElement('div');
    div.className = 'post-card animate-in';
    div.innerHTML = `
      <div class="post-header">
        <div class="ph-av" style="display:flex;align-items:center;justify-content:center;background:${author.gender==='male'?'var(--male)':'var(--female)'};border-radius:50%;width:40px;height:40px;font-size:1rem;flex-shrink:0">${genderEmoji(author.gender)}</div>
        <div class="ph-info">
          <div class="ph-name">${author.first} ${author.last} <span style="font-weight:400;color:var(--text3);font-size:.72rem">¬∑ ${typeEmoji} ${post.type}</span></div>
          <div class="ph-meta">${rel !== 'Family Member' ? rel + ' ¬∑ ' : ''}${timeAgo}</div>
        </div>
        <div class="ph-more" onclick="postMenu(event,'${post.id}')">‚ãØ</div>
      </div>
      <div class="post-text">${post.text}</div>
      ${post.type==='photo' ? `<div class="post-img-placeholder">üì∏</div>` : ''}
      <div style="padding:8px 16px 4px;font-size:.7rem;color:var(--text3)">${post.likes} likes ¬∑ ${post.comments} comments ¬∑ ${post.shares} shares</div>
      <div class="post-actions">
        <button class="post-action-btn ${post.liked?'liked':''}" onclick="toggleLike('${post.id}',this)"><span class="pab-icon">‚ù§Ô∏è</span> Like</button>
        <button class="post-action-btn" onclick="showToast('Comments coming soon!')"><span class="pab-icon">üí¨</span> Comment</button>
        <button class="post-action-btn" onclick="sharePost('${post.id}')"><span class="pab-icon">‚ÜóÔ∏è</span> Share</button>
      </div>`;
    container.appendChild(div);
  });
}

function toggleLike(postId, btn) {
  const post = DB.posts.find(p=>p.id===postId);
  if(!post) return;
  post.liked = !post.liked;
  post.likes += post.liked ? 1 : -1;
  btn.classList.toggle('liked', post.liked);
  btn.parentElement.previousElementSibling.textContent = `${post.likes} likes ¬∑ ${post.comments} comments ¬∑ ${post.shares} shares`;
  showToast(post.liked ? '‚ù§Ô∏è Liked!' : 'Like removed');
}

function sharePost(postId) {
  const post = DB.posts.find(p=>p.id===postId);
  if(post) { post.shares++; showToast('‚ÜóÔ∏è Shared with family!'); renderPosts(); }
}

function formatTimeAgo(ts) {
  const diff = Date.now() - ts;
  if(diff < 60000) return 'Just now';
  if(diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if(diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  return Math.floor(diff/86400000) + 'd ago';
}

function expandPostBox() {
  document.getElementById('post-actions').style.display='flex';
}

function postText() {
  const text = document.getElementById('post-input').value.trim();
  if(!text){ showToast('Please write something first'); return; }
  DB.posts.unshift({ id:'post'+Date.now(), authorId:currentUser.id, type:'update', text, timestamp:Date.now(), likes:0, liked:false, comments:0, shares:0 });
  document.getElementById('post-input').value='';
  document.getElementById('post-actions').style.display='none';
  renderPosts();
  showToast('‚úÖ Post shared!');
}

function createPost(type) {
  const modal = document.getElementById('post-modal');
  document.getElementById('pm-name').textContent = currentUser.first + ' ' + currentUser.last;
  document.getElementById('pm-type').value = type;
  document.getElementById('pm-text').value = document.getElementById('post-input').value;
  modal.classList.add('open');
}

function submitPost() {
  const text = document.getElementById('pm-text').value.trim();
  const type = document.getElementById('pm-type').value;
  if(!text){ showToast('Please write something'); return; }
  DB.posts.unshift({ id:'post'+Date.now(), authorId:currentUser.id, type, text, timestamp:Date.now(), likes:0, liked:false, comments:0, shares:0 });
  document.getElementById('post-modal').classList.remove('open');
  document.getElementById('post-input').value='';
  document.getElementById('post-actions').style.display='none';
  renderPosts();
  showToast('‚úÖ Post shared!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BIRTHDAYS & SUGGESTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBirthdays() {
  const list = document.getElementById('bday-list');
  list.innerHTML = '';
  const related = getAllRelated(currentUser.id).slice(0,4);
  related.forEach(rid => {
    const r = DB.users[rid];
    if(!r || !r.birth) return;
    const rel = computeRelation(currentUser.id, rid);
    const div = document.createElement('div');
    div.className = 'bday-item';
    div.innerHTML = `
      <div class="bday-av" style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:${r.gender==='male'?'var(--male)':'var(--female)'};font-size:1rem">${genderEmoji(r.gender)}</div>
      <div class="bday-info"><div class="bday-name">${r.first} ${r.last}</div><div class="bday-note">${rel} ¬∑ Born ${r.birth}</div></div>`;
    list.appendChild(div);
  });
  if(!related.length) list.innerHTML = '<div style="font-size:.75rem;color:var(--text3)">No upcoming birthdays</div>';

  // Suggestions
  const sugList = document.getElementById('suggestions-list');
  sugList.innerHTML = '';
  const allUsers = Object.values(DB.users).filter(u => u.id !== currentUser.id && !getAllRelated(currentUser.id).includes(u.id)).slice(0,3);
  allUsers.forEach(u => {
    const div = document.createElement('div');
    div.className = 'suggestion';
    div.innerHTML = `
      <div class="sug-av" style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:${u.gender==='male'?'var(--male)':'var(--female)'};font-size:1rem">${genderEmoji(u.gender)}</div>
      <div class="sug-info"><div class="sug-name">${u.first} ${u.last}</div><div class="sug-rel">${u.occ||'Family member'}</div></div>
      <button class="btn-invite" onclick="showToast('Invitation sent to ${u.first}!')">Invite</button>`;
    sugList.appendChild(div);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleNotifs() {
  document.getElementById('notif-panel').classList.toggle('open');
}
function renderNotifications() {
  const list = document.getElementById('notif-list');
  list.innerHTML = '';
  DB.notifications.forEach(n => {
    const fromUser = n.from ? DB.users[n.from] : null;
    const div = document.createElement('div');
    div.className = 'notif-item' + (n.unread?' unread':'');
    const icon = {family_add:'üë®‚Äçüë©‚Äçüëß',like:'‚ù§Ô∏è',comment:'üí¨',invite:'üì®',birthday:'üéÇ'}[n.type]||'üîî';
    div.innerHTML = `
      <div class="ni-av" style="width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--primary-light);font-size:1.2rem">${icon}</div>
      <div><div class="ni-text">${fromUser?`<strong>${fromUser.first} ${fromUser.last}</strong> `:''}${n.text}</div><div class="ni-time">${formatTimeAgo(n.time)}</div></div>`;
    div.onclick = () => { n.unread=false; div.classList.remove('unread'); };
    list.appendChild(div);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProfile(userId) {
  const u = DB.users[userId||currentUser.id] || currentUser;
  const name = u.first + ' ' + u.last;
  document.getElementById('profile-name-display').textContent = name;
  document.getElementById('profile-handle-display').textContent = '@' + u.first.toLowerCase() + u.last.toLowerCase() + ' ¬∑ Joined ' + new Date(u.joined).getFullYear();
  document.getElementById('pi-location').textContent = u.location || 'Location not set';
  document.getElementById('pi-occ').textContent = u.occ || 'Occupation not set';
  document.getElementById('pi-dob').textContent = u.birth ? 'Born ' + u.birth : 'Birthday not set';
  document.getElementById('pi-family-side').textContent = 'Anderson-Carter Family';

  const pAv = document.getElementById('profile-avatar-img');
  pAv.src = u.photo || '';
  if(!u.photo) {
    document.getElementById('profile-avatar-wrap').innerHTML = `<div style="width:90px;height:90px;border-radius:50%;border:4px solid var(--surface);background:${u.gender==='male'?'var(--male)':'var(--female)'};display:flex;align-items:center;justify-content:center;font-size:2.5rem">${genderEmoji(u.gender)}</div>`;
  }

  const related = getAllRelated(u.id);
  document.getElementById('ps-posts').textContent = DB.posts.filter(p=>p.authorId===u.id).length;
  document.getElementById('ps-family').textContent = related.length;
  document.getElementById('ps-photos').textContent = DB.posts.filter(p=>p.authorId===u.id&&p.type==='photo').length;

  // Family list
  const fl = document.getElementById('profile-family-list');
  fl.innerHTML = '';
  related.slice(0,6).forEach(rid => {
    const r = DB.users[rid];
    const rel = computeRelation(u.id, rid);
    const d = document.createElement('div');
    d.className = 'family-quick';
    d.style.cursor='pointer';
    d.innerHTML = `
      <div style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:${r.gender==='male'?'var(--male)':'var(--female)'};font-size:.9rem;flex-shrink:0">${genderEmoji(r.gender)}</div>
      <div><div style="font-size:.75rem;font-weight:500">${r.first} ${r.last}</div><div style="font-size:.65rem;color:var(--text3)">${rel}</div></div>`;
    d.onclick = ()=>openNodeDetailById(rid);
    fl.appendChild(d);
  });

  // Posts
  const myPosts = DB.posts.filter(p=>p.authorId===u.id);
  const mpl = document.getElementById('my-posts-list');
  mpl.innerHTML = myPosts.length ? '' : '<div style="font-size:.75rem;color:var(--text3)">No posts yet</div>';
  myPosts.forEach(post => {
    const d=document.createElement('div');
    d.style.cssText='padding:10px 0;border-bottom:1px solid var(--border);font-size:.78rem;';
    d.innerHTML=`<div style="color:var(--text3);font-size:.68rem;margin-bottom:3px">${formatTimeAgo(post.timestamp)}</div>${post.text.substring(0,120)}${post.text.length>120?'‚Ä¶':''}`;
    mpl.appendChild(d);
  });
}

function openEditProfile() {
  const u = currentUser;
  document.getElementById('ep-first').value = u.first;
  document.getElementById('ep-last').value = u.last;
  document.getElementById('ep-bio').value = u.bio;
  document.getElementById('ep-occ').value = u.occ;
  document.getElementById('ep-location').value = u.location;
  document.getElementById('ep-photo').value = u.photo;
  document.getElementById('edit-profile-modal').classList.add('open');
}

function saveEditProfile() {
  currentUser.first = document.getElementById('ep-first').value.trim() || currentUser.first;
  currentUser.last  = document.getElementById('ep-last').value.trim();
  currentUser.bio   = document.getElementById('ep-bio').value;
  currentUser.occ   = document.getElementById('ep-occ').value;
  currentUser.location = document.getElementById('ep-location').value;
  currentUser.photo = document.getElementById('ep-photo').value;
  document.getElementById('edit-profile-modal').classList.remove('open');
  updateNavUser();
  renderProfile();
  buildFamilyTree();
  showToast('‚úÖ Profile updated!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD MEMBER MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let addModalRefId = null;

function openAddMemberModal(refId, defaultRel) {
  addModalRefId = refId;
  const ref = DB.users[refId];
  document.getElementById('am-ref-name').textContent = refId === currentUser.id ? 'you' : (ref ? ref.first : 'them');
  document.getElementById('am-first').value='';
  document.getElementById('am-last').value = ref ? ref.last : '';
  document.getElementById('am-birth').value='';
  document.getElementById('am-occ').value='';
  document.getElementById('am-location').value='';
  document.getElementById('am-bio').value='';
  if(defaultRel) document.getElementById('am-relation').value = defaultRel;
  const token = 'inv-' + Math.random().toString(36).substr(2,9);
  document.getElementById('am-invite-link').value = window.location.href.split('?')[0] + '?invite=' + token;
  document.getElementById('add-modal-title').textContent = `Add Family Member${ref && ref.id !== currentUser.id ? ' to ' + ref.first + "'s tree" : ''}`;
  document.getElementById('add-modal').classList.add('open');
}

function closeAddModal() {
  document.getElementById('add-modal').classList.remove('open');
  addModalRefId = null;
}

function saveNewMember() {
  const first = document.getElementById('am-first').value.trim();
  if(!first){ showToast('Please enter a first name'); document.getElementById('am-first').focus(); return; }
  const relType = document.getElementById('am-relation').value;
  const newId = mkUID();
  DB.users[newId] = {
    id:newId,
    first, last:document.getElementById('am-last').value.trim(),
    gender: document.getElementById('am-gender').value,
    birth: document.getElementById('am-birth').value ? parseInt(document.getElementById('am-birth').value) : null,
    occ: document.getElementById('am-occ').value,
    location: document.getElementById('am-location').value,
    bio: document.getElementById('am-bio').value,
    photo:'', email:'', password:'',
    parentIds:[], childIds:[], spouseIds:[], siblingIds:[],
    grandparentIds:[], grandchildIds:[], uncleAuntIds:[],
    relationships:{}, posts:[], joined:new Date().toISOString()
  };

  linkRelationship(addModalRefId || currentUser.id, newId, relType);

  // Add notification
  DB.notifications.unshift({
    id:'n'+Date.now(), type:'family_add', from:currentUser.id,
    text:`added ${first} as ${relType.replace(/_/g,' ')} to the family tree`,
    time:Date.now(), unread:true
  });

  closeAddModal();
  renderSidebar();
  renderProfile();
  buildFamilyTree();
  renderNotifications();
  renderBirthdays();
  showToast(`‚úÖ ${first} added to the family tree!`);

  // Invite link notification
  const link = document.getElementById('am-invite-link').value;
  if(link) {
    DB.posts.unshift({
      id:'post'+Date.now(), authorId:currentUser.id, type:'announcement',
      text:`üå≥ I've added ${first} to our family tree on Kinship! ${first}, join us to see your family connections.`,
      timestamp:Date.now(), likes:0, liked:false, comments:0, shares:0
    });
    renderPosts();
  }
}

function copyInvite() { copyToClipboard(document.getElementById('am-invite-link').value); }
function copyInviteLink() { copyToClipboard(document.getElementById('invite-link-display').value); }
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).catch(()=>{});
  showToast('üìã Link copied to clipboard!');
}
function generateInviteLink() {
  const token = 'fam-' + currentUser.id + '-' + Math.random().toString(36).substr(2,6);
  document.getElementById('invite-link-display').value = window.location.href.split('?')[0] + '?join=' + token;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FAMILY TREE RENDERING (MIND-MAP STYLE)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let treeScale = 1, treePanX = 0, treePanY = 0;
let treePanning = false, treeLmx = 0, treeLmy = 0;
let nodePositions = {};
let selectedNodeId = null;

const NW = 120, NH = 88, HGAP = 160, VGAP = 130;

function buildFamilyTree() {
  nodePositions = {};
  layoutTree();
  renderTree();
  setupTreeInteraction();
}

function layoutTree() {
  // Layout algorithm: BFS from current user, assign positions in layers
  // Center = self, parents above, children below, spouses beside, siblings beside
  const u = currentUser;
  const placed = new Set();
  const SELF_X = 1500, SELF_Y = 900;

  nodePositions[u.id] = { x: SELF_X, y: SELF_Y };
  placed.add(u.id);

  // Place spouses
  let spouseOffset = 1;
  for(const spouseId of u.spouseIds) {
    if(!DB.users[spouseId]) continue;
    nodePositions[spouseId] = { x: SELF_X + spouseOffset * (NW + HGAP), y: SELF_Y };
    placed.add(spouseId);
    spouseOffset++;
  }

  // Place siblings
  let sibOffset = -1;
  for(const sibId of u.siblingIds) {
    if(!DB.users[sibId]) continue;
    if(placed.has(sibId)) continue;
    nodePositions[sibId] = { x: SELF_X + sibOffset * (NW + HGAP), y: SELF_Y };
    placed.add(sibId);
    sibOffset--;
    // Place sibling's spouse
    const sib = DB.users[sibId];
    for(const ssId of sib.spouseIds) {
      if(!DB.users[ssId]||placed.has(ssId)) continue;
      nodePositions[ssId] = { x: SELF_X + sibOffset * (NW + HGAP), y: SELF_Y };
      placed.add(ssId);
      sibOffset--;
    }
  }

  // Place parents (generation above)
  let pIdx = 0;
  const pCount = u.parentIds.length;
  for(const parentId of u.parentIds) {
    if(!DB.users[parentId]||placed.has(parentId)) continue;
    const px = SELF_X + (pIdx - (pCount-1)/2) * (NW + HGAP);
    nodePositions[parentId] = { x: px, y: SELF_Y - VGAP - NH };
    placed.add(parentId);
    pIdx++;
    const parent = DB.users[parentId];
    // Parent's spouses
    for(const psId of parent.spouseIds) {
      if(!DB.users[psId]||placed.has(psId)) continue;
      nodePositions[psId] = { x: px + NW + HGAP, y: SELF_Y - VGAP - NH };
      placed.add(psId);
    }
    // Parent's siblings (uncles/aunts)
    let uaOff = 0;
    for(const uaId of parent.siblingIds) {
      if(!DB.users[uaId]||placed.has(uaId)) continue;
      uaOff++;
      const pRel = u.relationships[parentId];
      const side = pRel ? (pRel.relType==='father'?'paternal':'maternal') : 'paternal';
      const xDir = side==='paternal' ? -1 : 1;
      nodePositions[uaId] = { x: px + xDir * (uaOff) * (NW + HGAP), y: SELF_Y - VGAP - NH };
      placed.add(uaId);
      // Uncle/aunt's spouse
      const ua = DB.users[uaId];
      for(const uasId of ua.spouseIds) {
        if(!DB.users[uasId]||placed.has(uasId)) continue;
        nodePositions[uasId] = { x: px + xDir * (uaOff) * (NW + HGAP) + xDir*(NW+HGAP), y: SELF_Y - VGAP - NH };
        placed.add(uasId);
      }
      // Uncle/aunt's children (cousins)
      let cOff = 0;
      for(const cousinId of ua.childIds) {
        if(!DB.users[cousinId]||placed.has(cousinId)) continue;
        nodePositions[cousinId] = { x: px + xDir * (uaOff) * (NW + HGAP) + cOff * (NW + 30), y: SELF_Y + VGAP + NH };
        placed.add(cousinId);
        cOff++;
      }
    }
    // Grandparents
    let gpOff = 0;
    for(const gpId of parent.parentIds) {
      if(!DB.users[gpId]||placed.has(gpId)) continue;
      nodePositions[gpId] = { x: px + (gpOff - 0.5) * (NW + HGAP), y: SELF_Y - 2*(VGAP + NH) };
      placed.add(gpId);
      gpOff++;
      // Grandparent's spouses
      const gp = DB.users[gpId];
      for(const gpsId of gp.spouseIds) {
        if(!DB.users[gpsId]||placed.has(gpsId)) continue;
        nodePositions[gpsId] = { x: px + (gpOff - 0.5) * (NW + HGAP), y: SELF_Y - 2*(VGAP + NH) };
        placed.add(gpsId);
        gpOff++;
      }
    }
  }

  // Place children (generation below)
  const allChildren = [...new Set([...u.childIds])];
  // Also include spouse's children
  for(const spId of u.spouseIds) {
    const sp = DB.users[spId];
    if(sp) sp.childIds.forEach(cid => { if(!allChildren.includes(cid)) allChildren.push(cid); });
  }
  let cIdx = 0;
  const cCount = allChildren.length;
  for(const childId of allChildren) {
    if(!DB.users[childId]||placed.has(childId)) continue;
    const cx = SELF_X + (cIdx - (cCount-1)/2) * (NW + HGAP);
    nodePositions[childId] = { x: cx, y: SELF_Y + VGAP + NH };
    placed.add(childId);
    cIdx++;
    // Child's spouses
    const child = DB.users[childId];
    for(const csId of child.spouseIds) {
      if(!DB.users[csId]||placed.has(csId)) continue;
      nodePositions[csId] = { x: cx + NW + HGAP, y: SELF_Y + VGAP + NH };
      placed.add(csId);
    }
    // Grandchildren
    let gcIdx = 0;
    for(const gcId of child.childIds) {
      if(!DB.users[gcId]||placed.has(gcId)) continue;
      nodePositions[gcId] = { x: cx + (gcIdx - (child.childIds.length-1)/2) * (NW + 50), y: SELF_Y + 2*(VGAP + NH) };
      placed.add(gcId);
      gcIdx++;
    }
  }

  // Resolve overlaps
  resolveOverlaps();
}

function resolveOverlaps() {
  const ids = Object.keys(nodePositions);
  let changed = true;
  let iterations = 0;
  while(changed && iterations < 50) {
    changed = false;
    iterations++;
    for(let i=0;i<ids.length;i++) {
      for(let j=i+1;j<ids.length;j++) {
        const a = nodePositions[ids[i]];
        const b = nodePositions[ids[j]];
        const dx = Math.abs(a.x - b.x);
        const dy = Math.abs(a.y - b.y);
        const minDx = NW + 30;
        const minDy = NH + 20;
        if(dx < minDx && dy < minDy) {
          // Push apart horizontally
          const push = (minDx - dx) / 2 + 5;
          if(a.x <= b.x) { a.x -= push; b.x += push; }
          else { a.x += push; b.x -= push; }
          changed = true;
        }
      }
    }
  }
}

function renderTree() {
  const canvas = document.getElementById('tree-canvas');
  const svg = document.getElementById('tree-svg');

  // Remove old nodes
  canvas.querySelectorAll('.tnode,.rel-path-tag').forEach(n=>n.remove());
  svg.innerHTML = '';

  const u = currentUser;

  // Draw connections first (SVG)
  let svgContent = '';
  const drawnEdges = new Set();

  function drawEdge(aId, bId, type) {
    const key = [aId,bId].sort().join(':') + ':' + type;
    if(drawnEdges.has(key)) return;
    drawnEdges.add(key);
    const a = nodePositions[aId], b = nodePositions[bId];
    if(!a||!b) return;
    const ax = a.x + NW/2, ay = a.y + NH/2;
    const bx = b.x + NW/2, by = b.y + NH/2;
    const mx = (ax+bx)/2, my = (ay+by)/2;

    if(type==='spouse') {
      // Dashed horizontal-ish line
      svgContent += `<path d="M${ax},${ay} C${mx},${ay} ${mx},${by} ${bx},${by}" fill="none" stroke="#c17f3a" stroke-width="2" stroke-dasharray="6,4" opacity="0.7"/>`;
    } else if(type==='parent-child') {
      // Smooth curved line
      const ctrl1y = ay + (by-ay)*0.4;
      const ctrl2y = by - (by-ay)*0.4;
      svgContent += `<path d="M${ax},${ay+NH/2-4} C${ax},${ctrl1y} ${bx},${ctrl2y} ${bx},${by-NH/2+4}" fill="none" stroke="var(--primary)" stroke-width="1.8" opacity="0.6"/>`;
    } else if(type==='sibling') {
      // Lighter curved line
      svgContent += `<path d="M${ax},${ay} Q${mx},${my-20} ${bx},${by}" fill="none" stroke="#8B5CF6" stroke-width="1.5" stroke-dasharray="3,3" opacity="0.5"/>`;
    }
  }

  // Draw all connections
  for(const uid in nodePositions) {
    const person = DB.users[uid];
    if(!person) continue;
    // Spouse connections
    person.spouseIds.forEach(sid => { if(nodePositions[sid]) drawEdge(uid,sid,'spouse'); });
    // Parent-child connections
    person.childIds.forEach(cid => { if(nodePositions[cid]) drawEdge(uid,cid,'parent-child'); });
    // Sibling connections
    person.siblingIds.forEach(sid => { if(nodePositions[sid]) drawEdge(uid,sid,'sibling'); });
  }

  svg.innerHTML = svgContent;

  // Render nodes
  for(const uid in nodePositions) {
    const pos = nodePositions[uid];
    const person = DB.users[uid];
    if(!person) continue;
    const rel = computeRelation(currentUser.id, uid);
    const relClass = getRelationClass(rel);
    const isSelf = uid === currentUser.id;
    const pRel = currentUser.relationships[uid];
    const side = pRel ? pRel.side : '';

    const node = document.createElement('div');
    node.className = `tnode${isSelf?' self-node':''}${side&&side!=='both'?' '+side:''}`;
    node.id = 'tnode-' + uid;
    node.style.left = pos.x + 'px';
    node.style.top  = pos.y + 'px';

    const sideTag = side && side!=='both' ? `<div class="tnode-side-tag ${side}">${side}</div>` : '';
    const photoContent = person.photo
      ? `<img src="${person.photo}" alt="${person.first}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`
      : `<div style="width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:${person.gender==='male'?'var(--male)':'var(--female)'};font-size:1.4rem;margin:0 auto 6px">${genderEmoji(person.gender)}</div>`;

    node.innerHTML = `
      ${sideTag}
      ${person.photo ? `<div class="tnode-photo"><img src="${person.photo}" alt="${person.first}" style="width:100%;height:100%;object-fit:cover"></div>` : photoContent}
      <div class="tnode-name">${person.first} ${person.last}</div>
      ${isSelf ? '<div class="tnode-rel rel-self">You</div>' : `<div class="tnode-rel ${relClass}">${rel}</div>`}
      <div class="tnode-actions">
        <div class="tna-btn" title="Add relation" onclick="event.stopPropagation();openAddMemberModal('${uid}','son')">+</div>
        <div class="tna-btn" title="View details" onclick="event.stopPropagation();openNodeDetailById('${uid}')">üëÅ</div>
        <div class="tna-btn" title="View profile" onclick="event.stopPropagation();viewMemberProfile('${uid}')">üë§</div>
      </div>`;

    node.addEventListener('click', () => openNodeDetailById(uid));
    canvas.appendChild(node);
  }

  // Update canvas size
  const positions = Object.values(nodePositions);
  if(positions.length > 0) {
    const maxX = Math.max(...positions.map(p=>p.x)) + NW + 100;
    const maxY = Math.max(...positions.map(p=>p.y)) + NH + 100;
    canvas.style.minWidth = maxX + 'px';
    canvas.style.minHeight = maxY + 'px';
    svg.setAttribute('width', maxX);
    svg.setAttribute('height', maxY);
    svg.setAttribute('viewBox', `0 0 ${maxX} ${maxY}`);
  }

  document.getElementById('tree-view-label').textContent = `${Object.keys(nodePositions).length} members`;
}

function fitTreeToScreen() {
  const wrap = document.getElementById('tree-canvas-wrap');
  const positions = Object.values(nodePositions);
  if(!positions.length) return;
  const minX = Math.min(...positions.map(p=>p.x)) - 20;
  const minY = Math.min(...positions.map(p=>p.y)) - 20;
  const maxX = Math.max(...positions.map(p=>p.x)) + NW + 20;
  const maxY = Math.max(...positions.map(p=>p.y)) + NH + 20;
  const treeW = maxX - minX, treeH = maxY - minY;
  const wrapW = wrap.clientWidth, wrapH = wrap.clientHeight;
  const newScale = Math.min(wrapW/treeW, wrapH/treeH, 1) * 0.9;
  const centX = minX + treeW/2, centY = minY + treeH/2;
  wrap.scrollLeft = centX * newScale - wrapW/2;
  wrap.scrollTop  = centY * newScale - wrapH/2;
  treeScale = newScale;
  applyTreeScale();
}

function resetTreeZoom() { treeScale=1; applyTreeScale(); }

function treeZoom(d) { treeScale = Math.min(2, Math.max(0.3, treeScale+d)); applyTreeScale(); }

function applyTreeScale() {
  document.getElementById('tree-canvas').style.transform = `scale(${treeScale})`;
  document.getElementById('tree-canvas').style.transformOrigin = '0 0';
  document.getElementById('tz-label').textContent = Math.round(treeScale*100) + '%';
}

function setupTreeInteraction() {
  const wrap = document.getElementById('tree-canvas-wrap');
  if(wrap._treeInteractionSet) return;
  wrap._treeInteractionSet = true;

  wrap.addEventListener('wheel', e => {
    if(e.ctrlKey||e.metaKey) {
      e.preventDefault();
      treeZoom(e.deltaY > 0 ? -.08 : .08);
    }
  }, {passive:false});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NODE DETAIL PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openNodeDetailById(uid) {
  const person = DB.users[uid];
  if(!person) return;
  selectedNodeId = uid;
  const rel = computeRelation(currentUser.id, uid);
  const relClass = getRelationClass(rel);
  const name = person.first + ' ' + person.last;

  // Highlight node
  document.querySelectorAll('.tnode').forEach(n=>n.classList.remove('hovered'));
  const nodeEl = document.getElementById('tnode-'+uid);
  if(nodeEl) nodeEl.classList.add('hovered');

  const avEl = document.getElementById('ndp-avatar');
  avEl.innerHTML = `<div style="width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:${person.gender==='male'?'var(--male)':'var(--female)'};font-size:2rem">${genderEmoji(person.gender)}</div>`;
  avEl.style.background='none';
  document.getElementById('ndp-name').textContent = name;
  const relSpan = document.getElementById('ndp-rel');
  relSpan.textContent = rel;
  relSpan.className = 'ndp-rel ' + relClass;

  const rows = document.getElementById('ndp-rows');
  rows.innerHTML = '';
  const r = (l,v) => {
    if(!v) return;
    const d=document.createElement('div');
    d.className='ndp-detail-row';
    d.innerHTML=`<span class="ndp-detail-label">${l}</span><span>${v}</span>`;
    rows.appendChild(d);
  };
  r('Born', person.birth);
  r('Gender', person.gender.charAt(0).toUpperCase()+person.gender.slice(1));
  r('Occupation', person.occ);
  r('Location', person.location);
  r('Bio', person.bio);

  const spouses = person.spouseIds.map(id=>DB.users[id]).filter(Boolean);
  if(spouses.length) r('Spouse', spouses.map(s=>s.first+' '+s.last).join(', '));
  const parents = person.parentIds.map(id=>DB.users[id]).filter(Boolean);
  if(parents.length) r('Parents', parents.map(p=>p.first).join(' & '));
  if(person.childIds.length) r('Children', person.childIds.length + ' child' + (person.childIds.length>1?'ren':''));
  if(person.siblingIds.length) r('Siblings', person.siblingIds.length);

  const actions = document.getElementById('ndp-actions');
  actions.innerHTML = `
    <button class="ndp-action-btn ndp-btn-add" onclick="openAddMemberModal('${uid}','son')">+ Add Relation to ${person.first}</button>
    <button class="ndp-action-btn ndp-btn-add" onclick="openAddMemberModal('${uid}','spouse')">‚ô• Add Spouse for ${person.first}</button>
    <button class="ndp-action-btn ndp-btn-edit" onclick="viewMemberProfile('${uid}')">üë§ View Profile</button>
    ${uid !== currentUser.id ? `<button class="ndp-action-btn ndp-btn-edit" onclick="viewAsUser('${uid}')">üëÅ View tree as ${person.first}</button>` : ''}`;

  document.getElementById('node-detail-panel').classList.add('open');
}

function closeNodeDetail() {
  document.getElementById('node-detail-panel').classList.remove('open');
  document.querySelectorAll('.tnode').forEach(n=>n.classList.remove('hovered'));
  selectedNodeId = null;
}

function viewMemberProfile(uid) {
  renderProfile(uid);
  showPage('profile');
  closeNodeDetail();
}

function viewAsUser(uid) {
  // Temporarily view tree from another user's perspective
  const original = currentUser.id;
  const tempUser = DB.users[uid];
  if(!tempUser) return;
  currentUser = tempUser;
  buildFamilyTree();
  document.getElementById('tree-view-label').textContent = `Viewing as ${tempUser.first}`;
  closeNodeDetail();
  showToast(`üëÅ Viewing tree as ${tempUser.first}`);
  setTimeout(() => {
    currentUser = DB.users[original];
    buildFamilyTree();
    showToast('üëÅ Returned to your view');
  }, 10000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(()=>t.classList.remove('show'), 2800);
}

function handleSearch(val) {
  if(!val) return;
  const results = Object.values(DB.users).filter(u =>
    (u.first+' '+u.last).toLowerCase().includes(val.toLowerCase())
  );
  if(results.length) showToast(`Found: ${results.map(r=>r.first).join(', ')}`);
}

function postMenu(e, postId) {
  e.stopPropagation();
  showToast('Post options: Edit, Delete, Report');
}

function editCover() { showToast('Cover photo editing coming soon!'); }

document.addEventListener('click', (e) => {
  if(!e.target.closest('#notif-panel') && !e.target.closest('#notif-btn')) {
    document.getElementById('notif-panel').classList.remove('open');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
seedData();
// Check for invite link
const urlParams = new URLSearchParams(window.location.search);
if(urlParams.get('invite') || urlParams.get('join')) {
  showToast('üéâ You have been invited! Sign up to join your family tree.');
}
</script>
</body>
</html>
